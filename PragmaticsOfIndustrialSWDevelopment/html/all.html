<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Pragmatics of Industrial Software Development</title>
<!-- metadata -->
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="generator" content="S5" />
<meta name="version" content="S5 1.1" />
<meta name="date" content="August 5, 2010" />
<meta name="author" content="Dean Wampler, Ph.D." />
<meta name="company" content="Department of Computer Science,<br/>Loyola University Chicago" />
<meta name="copyright" content="2010 Dean Wampler, All Rights Reserved" />
<!-- configuration parameters -->
<meta name="defaultView" content="slideshow" />
<meta name="controlVis" content="hidden" />
<!-- style sheet links -->
<link rel="stylesheet" href="../ui/default/slides.css" type="text/css" media="projection" id="slideProj" />
<link rel="stylesheet" href="../ui/default/outline.css" type="text/css" media="screen" id="outlineStyle" />
<link rel="stylesheet" href="../lib/stylesheets/print.css" type="text/css" media="print" id="slidePrint" />
<link rel="stylesheet" href="../ui/default/opera.css" type="text/css" media="projection" id="operaFix" />

<link rel="stylesheet" href="../lib/stylesheets/pressie.css" type="text/css" />

<!-- S5 JS -->
<script src="../ui/default/slides.js" type="text/javascript"></script>

<!-- Syntax Highlighter -->
<!-- <link rel="stylesheet"  href="../lib/stylesheets/SyntaxHighlighter.css"></link> -->
<link type="text/css" rel="stylesheet" href="../lib/stylesheets/shCore.css"/>
<link type="text/css" rel="stylesheet" href="../lib/stylesheets/shThemeDefault.css"/>


</head>
<body>

<div class="layout">
<div id="controls"><!-- DO NOT EDIT --></div>
<div id="currentSlide"><!-- DO NOT EDIT --></div>
<div id="header"></div>
<div id="footer">
<h2>Copyright &copy; 2010 Dean Wampler, All Rights Reserved</h2>
<h2>August 5, 2010</h2>
</div>

</div>


<div class="presentation">
<div class="slide">
<h1>Pragmatics of Industrial Software Development</h1>
<blockquote>
<p><span class="caps">COMP</span> 388-003, 488-007</p>
</blockquote>
<blockquote>
<p>Dean Wampler, Ph.D.<br />
<a href="mailto:kwampler@luc.edu">kwampler@luc.edu</a><br />
<a href="mailto:dean@deanwampler.com">dean@deanwampler.com</a><br />
<a href="http://twitter.com/@deanwampler">@deanwampler</a><br />
Department of Computer Science,<br/>Loyola University Chicago</p>
</blockquote>
</div>
<div class="slide">
<h1>Contents</h1>
<div style="font-size: 70%">
<ul>
	<li>Lecture 1: Course Introduction and Scaling Computation, Part I</li>
</ul>
<ul>
	<li>Lecture 2: Scaling Computation, Part II, and Course Project Rebooted</li>
</ul>
<ul>
	<li>Lecture 3: Scaling Systems, Part I</li>
</ul>
<ul>
	<li>Lecture 4: Scaling Data, Part I</li>
</ul>
<ul>
	<li>Lecture 5: Scaling Data, Part II</li>
</ul>
<ul>
	<li>Lecture 6: Scaling Data, Part <span class="caps">III</span></li>
</ul>
<ul>
	<li>Lecture 7: Midterm Break (No Class)</li>
</ul>
<ul>
	<li>Lecture 8: Midterm and Scaling Systems, Part II</li>
</ul>
<ul>
	<li>Lecture 9: Recent Advances in Object-Oriented Programming (<span class="caps">OOP</span>)</li>
</ul>
<ul>
	<li>Lecture 10: Functional Programming (FP): Into the Real World</li>
</ul>
<ul>
	<li>Lecture 11: Object-Oriented Programming vs. Functional Programming: a Critique of Pure Programming</li>
</ul>
<ul>
	<li>Lecture 12: Complexity vs. Simplicity Part I: Effective Software Development Processes</li>
</ul>
<ul>
	<li>Lecture 13: Complexity vs. Simplicity Part II: Scrum, XP, and Lean</li>
</ul>
<ul>
	<li>Lecture 14: Complexity vs. Simplicity Part <span class="caps">III</span>: Simple Systems</li>
</ul>
<ul>
	<li>Lecture 15: Student Presentations on the Code Project and Course Review</li>
</ul>
</div>
</div>
<div class="title slide">
<h1>Lecture 1: Course Introduction and Scaling Computation, Part I</h1>
</div>
<div class="slide">
<h1>Course Introduction</h1>
<p>You have learned about many aspects of software development in your studies. This course looks at how different ideas actually succeed or fail when applied in modern &#8220;industrial&#8221; (i.e., professional) settings.</p>
<p>It reflects my 20+ years of industry experience and my interest in the efficacy of academic Computer Science.</p>
</div>
<div class="slide">
<h1>Course Learning Objectives</h1>
<p>(See the course syllabus on <a href="http://blackboard.luc.edu/">Blackboard</a> for details.)</p>
<ol>
	<li>Understand why some ideas succeed, some fail, and others grow and decline in popularity as circumstances change.</li>
	<li>Recognize key traits of successful systems, methods, and tools.
	<ul>
		<li>For example, the importance of <em>simplicity</em>.</li>
	</ul></li>
	<li>Gain hands-on experience with trending technologies.</li>
</ol>
</div>
<div class="slide">
<h1>General Principles Covered</h1>
<ul>
	<li>Scaling through concurrency &#8211; effective approaches.</li>
	<li>Scaling data &#8211; new models of persistence and data analysis.</li>
	<li>Object-oriented and functional programming &#8211; an assessment.</li>
	<li>Simplicity in software design &#8211; why it’s important and how to achieve it.</li>
	<li>Software development processes &#8211; what works and why.</li>
</ul>
</div>
<div class="slide">
<h1>Topics that Apply these Principles</h1>
<ul>
	<li>Models of fine-grained, concurrent software for robust, horizontal scalability.</li>
	<li>Distributed systems for large-scale, course-grained scalability.</li>
	<li><span class="caps">SQL</span> and “NoSQL” databases &#8211; finding the right persistence model.</li>
	<li>Internet-scale data processing and analytics.</li>
	<li><em>Agile Methodologies</em> for software development.</li>
</ul>
</div>
<div class="slide">
<h1>Course <em>Administrivia</em></h1>
<table>
	<tr>
		<td> email: </td>
		<td> <a href="mailto:kwampler@luc.edu">kwampler@luc.edu</a>  <br/> <a href="dean@deanwampler.com">dean@deanwampler.com</a> </td>
	</tr>
	<tr>
		<td> twitter: </td>
		<td> <a href="http://twitter.com/deanwampler">@deanwampler</a> </td>
	</tr>
	<tr>
		<td> office hours: </td>
		<td> Tuesday, 6:45 &#8211; ? and by appointment </td>
	</tr>
</table>
</div>
<div class="slide">
<h1>Schedule</h1>
<table>
	<tr>
		<td>  8/31 </td>
		<td> Course Intro and Scaling Computation, Part I (Multithreaded Programming, Actor Concurrency) </td>
	</tr>
	<tr>
		<td>  9/07 </td>
		<td> Scaling Computation, Part II (Agents, Software Transactional Memory, Memory is the New Disk) </td>
	</tr>
	<tr>
		<td>  9/14 </td>
		<td> Scaling Systems, Part I (Vertical vs. Horizontal Scaling, Distributed Systems like <span class="caps">HTTP</span>, etc.) <em>Last day to withdraw without a W grade.</em> </td>
	</tr>
	<tr>
		<td>  9/21 </td>
		<td> Scaling Data, Part I (<span class="caps">SQL</span> vs. NoSQL databases) </td>
	</tr>
	<tr>
		<td>  9/28 </td>
		<td> Scaling Data, Part II (Example NoSQL databases) </td>
	</tr>
</table>
</div>
<div class="slide">
<h1>Schedule (cont.)</h1>
<table>
	<tr>
		<td> 10/05 </td>
		<td> Scaling Data, Part <span class="caps">III</span> (Example NoSQL databases) </td>
	</tr>
	<tr>
		<td> 10/12 </td>
		<td> Midterm break </td>
	</tr>
	<tr>
		<td> 10/19 </td>
		<td> Midterm, Scaling Systems, Part II (MapReduce and Their Kin) </td>
	</tr>
	<tr>
		<td> 10/26 </td>
		<td> Recent Advances in Object-Oriented Programming </td>
	</tr>
	<tr>
		<td> 11/02 </td>
		<td> Functional Programming: Into the Real World </td>
	</tr>
	<tr>
		<td> 11/09 </td>
		<td> Object-Oriented Programming vs. Functional Programming: a Critique of Pure Programming </td>
	</tr>
</table>
</div>
<div class="slide">
<h1>Schedule (cont.)</h1>
<table>
	<tr>
		<td> 11/16 </td>
		<td> Complexity vs. Simplicity Part I: Effective Software Development Processes </td>
	</tr>
	<tr>
		<td> 11/23 </td>
		<td> Complexity vs. Simplicity Part II: Scrum, XP, and Lean </td>
	</tr>
	<tr>
		<td> 11/30 </td>
		<td> Complexity vs. Simplicity Part <span class="caps">III</span>: Simple Systems </td>
	</tr>
	<tr>
		<td> 12/07 </td>
		<td> Student Presentations on the Code Project, Course Review </td>
	</tr>
	<tr>
		<td> 12/14 </td>
		<td> Final Exam (regular class time) </td>
	</tr>
</table>
</div>
<div class="slide">
<h1>Readings</h1>
<p>Due to the broad scope and topical nature of this course, there is no assigned textbook. A list of books and papers will be recommended for further reference. Specific reading assignments of on-line or library materials will be given as homework.</p>
<p>See the <a href="references.html">References</a>.</p>
</div>
<div class="slide">
<h1>Course Components: Grading</h1>
<table>
  <tr><td colspan='2'>Midterm</td><td>30%</td></tr>
  <tr><td colspan='2'>Final Exam</td><td>30%</td></tr>
  <tr><td colspan='2'>Project</td><td>40%</td></tr>
  <tr><td>20%</td><td>Code quality, correctness</td><td>&nbsp;</td></tr>
  <tr><td>15%</td><td>Individual contributions</td><td>&nbsp;</td></tr>
  <tr><td>5%</td><td>Final oral presentation</td><td>&nbsp;</td></tr>
  <tr><td colspan='2'>&nbsp;</td><td>100%</td></tr>
</table>
</div>
<div class="slide">
<h1>Course Components: Readings and Lecture</h1>
<ul>
	<li><strong>Readings:</strong>  Expand on the current week&#8217;s topics and preview next week&#8217;s topics. Please read them before coming to class.</li>
	<li><strong>Lecture:</strong>  Summarize and expand upon the readings, discuss the current project assignment. There will also be group discussions. The lecture notes will be posted to blackboard and <a href="http://github.com/deanwampler/Presentations/tree/master/PragmaticsOfIndustrialSWDevelopment/">GitHub.com</a> before each class.</li>
</ul>
</div>
<div class="slide">
<h1>Course Components: Project Exercises</h1>
<ul>
	<li>Start with a &#8220;running&#8221; 3-tier Scala application<br />
 * Hosted on <a href="http://github.com">GitHub.com</a> at <a href="http://github.com/deanwampler/AkkaWebSampleExercise">github.com/deanwampler/AkkaWebSampleExercise</a>. <br />
 * Uses <em>actors</em> to scale computation over a <span class="caps">NYSE</span> data set.<br />
 * Add features during the semester.<br />
 * <em>Refactor</em> the code to improve it and accommodate new features.</li>
</ul>
</div>
<div class="slide">
<h1>Course Components: Project Exercises (cont.)</h1>
<ul>
	<li><em>You are encouraged to work together.</em><br />
 * Like you would in an industrial setting&#8230;<br />
 * I expect the solutions to look &#8220;similar&#8221;.</li>
</ul>
</div>
<div class="slide">
<h1>Course Components: Project Exercises (cont.)</h1>
<p>&#8230; but</p>
<ul>
	<li>1/2 the grade differences will be based on GitHub checkin logs and the quality of those checkins.</li>
	<li><strong>If you <em>pair program</em>, include <em>both</em> names in the commit comments!</strong></li>
</ul>
h1. Course Components: Project Exercises (cont.)
<ul>
	<li>5% will be based on an <strong>oral presentation</strong> on 12/7.</li>
	<li>15 minutes or so, with time for questions and discussion.</li>
	<li>Topics to be worked out with me.<br />
  <br />
</div><br />
<div class="slide"></li>
</ul>
<h1>Midterm and Final Exam</h1>
<ul>
	<li>Will cover the reading, lecture material, and concepts learned in the exercises.</li>
	<li>Final exam content weighted:<br />
 * 2/3 of the material since the midterm <br />
 * 1/3 material before the midterm.</li>
	<li>Midterm: 10/19 (first half of that evening&#8217;s session).</li>
	<li>Final exam: 12/14 (usual class time).</li>
</ul>
</div>
<div class="slide">
<h1>Miscellaneous</h1>
<ul>
	<li>Academic Integrity Policy</li>
	<li>Students with Disabilities</li>
	<li>Attendance Policy</li>
	<li>Use of Blackboard</li>
	<li>Turning in Homework</li>
</ul>
</div>
<div class="slide">
<h1>Scaling Computation, Part I</h1>
<ul>
	<li>Two models of concurrency compared: <br />
  * Multithreaded Programming.<br />
  * The Actor Model of concurrency.</li>
</ul>
</div>
<div class="slide">
<h1>Multithreaded Programming</h1>
<ul>
	<li>Synchronized, shared access to <em>mutable</em> state.</li>
	<li><em>Lock-based Concurrency</em></li>
</ul>
</div>
<div class="slide">
<h1>Multithreaded Programming</h1>
<ul>
	<li><strong>Very</strong> hard to get write.</li>
	<li>Even experts stumble&#8230;</li>
</ul>
</div>
<div class="slide">
<h1>&#8220;Java Concurrency in Practice&#8221;</h1>
<p>Brian Goetz, et al.</p>
<p><img src="images/javaconcurrencyinpracticebook.jpg"><img></div>
<div class="slide">
<h1>Is This Safe?</h1>
<div class="code-normal">
<pre name="code" id="code" class="brush: scala;">@NotThreadSafe
public class UnsafeSequence {
  private int value;
  
  /** Returns a unique value. */
  public int getNext() {
    return value++;
  }
}</pre><p></div><div class="codeurl"><a href="txmt://open?url=file:///Users/dwampler/projects/Loyola/COMP388-488/Presentations/PragmaticsOfIndustrialSWDevelopment/code/UnsafeSequence.java">code/UnsafeSequence.java</a></div></p>
<p>(credit: all Multithreading examples adapted from &#8220;Java Concurrency in Practice&#8221;)</p>
</div>
<div class="slide">
<h1>This Is Safe</h1>
<div class="code-normal">
<pre name="code" id="code" class="brush: scala;">@ThreadSafe
public class Sequence {
  @GuardedBy("this") private int value;
  
  /** Returns a unique value. */
  public synchronized int getNext() {
    return value++;
  }
}</pre><p></div><div class="codeurl"><a href="txmt://open?url=file:///Users/dwampler/projects/Loyola/COMP388-488/Presentations/PragmaticsOfIndustrialSWDevelopment/code/SafeSequence.java">code/SafeSequence.java</a></div></p>
</div>
<div class="slide">
<h1>Things Can Go Wrong</h1>
<ul>
	<li><strong>Safety</strong> &#8211; Nothing Bad Should Happen</li>
	<li><strong>Liveness</strong> &#8211; Something Good Should Eventually Happen</li>
</ul>
</div>
<div class="slide">
<h1>Ways to Lose Liveness</h1>
<ul>
	<li><strong>Deadlock</strong></li>
</ul>
<p><em>You have a lock I want and I have a lock you want.</em></p>
</div>
<div class="slide">
<h1>Deadlock Example</h1>
<div class="code-normal">
<pre name="code" id="code" class="brush: scala;">@NotThreadSafe
public class LeftRightDeadlock {
  private final Object left  = new Object();
  private final Object right = new Object();
  
  public void leftRight() {
    synchronized (left) {
      synchronized (right) { doSomething(); }
  }
  public void rightLeft() {
    synchronized (right) {
      synchronized (left) { doSomethingElse(); }
  }
}</pre><p></div><div class="codeurl"><a href="txmt://open?url=file:///Users/dwampler/projects/Loyola/COMP388-488/Presentations/PragmaticsOfIndustrialSWDevelopment/code/LeftRightDeadlock.java">code/LeftRightDeadlock.java</a></div></p>
</div>
<div class="slide">
<h1>Other Deadlock Hazards</h1>
<ul>
	<li>Don&#8217;t call an external resource from a synchronized method, as it might try to acquire a lock&#8230; Make only <em>open calls.</em></li>
	<li>Similarly, avoid resource acquisition during locks.</li>
	<li>Don&#8217;t lock on a mutable object from different locations. Localize the locking to one place, where it&#8217;s easier to manage the policy for that object.</li>
</ul>
</div>
<div class="slide">
<h1>Starvation</h1>
<p>One thread can never get the resources it needs because other threads, often with inverted priorities, get too much access.</p>
<ul>
	<li>Avoid setting thread priorities. Operating Systems are already very good at this.</li>
</ul>
</div>
<div class="slide">
<h1>Livelock</h1>
<p>A thread is not blocked, but it can&#8217;t complete work because of trying operations always fails.</p>
<ul>
	<li>A common example is repeated execution of a transaction that never succeeds.</li>
	<li>One scenario is two contenders with identical strategies for trying again, often colliding in the same way. If one is <em>greedy</em>, both may succeed.<br />
 <br />
</div><br />
<div class="slide"></li>
</ul>
<h1>The Importance of Immutability</h1>
<p>What about access to <em>immutable</em> state? All the synchronization issues go away. Immutable objects have these virtues:</p>
<ul>
	<li>No synchronized access is required.</li>
	<li>They are automatically thread safe.</li>
</ul>
</div>
<div class="slide">
<h1>The Actor Model of Concurrency</h1>
<p>Autonomous &#8220;actors&#8221; receive messages, performing <em>local</em> computations, and sending new messages.</p>
<ul>
	<li>Coordinates and localizes state transitions.</li>
	<li>A higher-level abstraction than lock-based concurrency.</li>
	<li>Successful practical implementations in Erlang, Scala, and other languages.</li>
	<li>Mathematical model of concurrency going back to 1973.</li>
</ul>
</div>
<div class="slide">
<h1>Actors in Scala (Akka)</h1>
<div class="code-normal">
<pre name="code" id="code" class="brush: scala;">package management
import se.scalablesolutions.akka.actor._

class Manager {
  private var managedActors: List[ActorRef] = Nil
  
  def receive = {
    case Register(actor: ActorRef) =&gt; 
      managedActors ::= actor
    case Unregister(actor: ActorRef) =&gt; 
      managedActors -= actor
    case Stop  =&gt; managedActors foreach (_ ! Stop)
    case Start =&gt; managedActors foreach (_ ! Start)
  }
}
</pre><p></div><div class="codeurl"><a href="txmt://open?url=file:///Users/dwampler/projects/Loyola/COMP388-488/Presentations/PragmaticsOfIndustrialSWDevelopment/code/manager-actor.scala">code/manager-actor.scala</a></div></p>
</div>
<div class="slide">
<h1>Actors in Scala (Akka)</h1>
<ul>
	<li>This is an example using the Akka Framework (<a href="http://akkasource.org">akkasource.org</a>) (used in the project).</li>
	<li>Scala also comes with its own Actor library.</li>
</ul>
</div>
<div class="slide">
<h1>Actors in Scala (Akka)</h1>
<ul>
	<li>Our example was contrived; Akka has a rich <code>Supervisor</code> mechanism.</li>
	<li>Inspired by Erlang&#8217;s <span class="caps">OTP</span> (<em>Open Telecom Platform</em>).</li>
	<li>A supervisor manages the lifecycle of N actors.</li>
</ul>
</div>
<div class="slide">
<h1>Supervisors and Lifecycle Management</h1>
<p>The Supervisor can</p>
<ul>
	<li>restart a failed actor (<em>One for One</em>).</li>
	<li>restart a group of coordinated actors, if one fails (<em>All for One</em>).</li>
	<li>itself be supervised (hierarchy)</li>
</ul>
</div>
<div class="slide">
<h1>&#8220;Let It Crash&#8221;</h1>
<p>For many systems, which is better?</p>
<ul>
	<li>A few, large processes that attempt error recovery, or</li>
	<li>Many, small processes where if one has an error, it can just die and be restarted?</li>
</ul>
<p>Complex processes require complex error handling and recovery. The actor model makes <em>modules</em> simpler and more robust, so the system is more robust.</p>
</div>
<div class="slide">
<h1>Starting an Akka Actor</h1>
<div class="code-normal">
<pre name="code" id="code" class="brush: scala;">class Manager {
  private var managedActors: List[ActorRef] = Nil
  
  def receive = { ... }
  }
}

...
import se.scalablesolutions.akka.actor.Actor_
// Creating an actor (one way...) and starting
val manager = Actor.actorOf[Manager]
manager.start</pre><p></div><div class="codeurl"><a href="txmt://open?url=file:///Users/dwampler/projects/Loyola/COMP388-488/Presentations/PragmaticsOfIndustrialSWDevelopment/code/manager-actor2.scala">code/manager-actor2.scala</a></div></p>
</div>
<div class="slide">
<h1>Actor vs. ActorRef</h1>
<p>The <code>ActorRef</code> returned by <code>actorOf</code> is a <em>handle</em> that separates clients from the actual Actor <em>body</em>.</p>
<p>This allows the supervisor to restart the <em>body</em> without disrupting client connections!</p>
</div>
<div class="slide">
<h1>Sending a Message to an Akka Actor</h1>
<p>First, define a <em>sealed</em> collection of messages.</p>
<div class="code-normal">
<pre name="code" id="code" class="brush: scala;">package management
import se.scalablesolutions.akka.actor._

sealed trait ManagementMessage

case class  Register(actor: ActorRef)
case class  Unregister(actor: ActorRef)
case object Stop
case object Start
</pre><p></div><div class="codeurl"><a href="txmt://open?url=file:///Users/dwampler/projects/Loyola/COMP388-488/Presentations/PragmaticsOfIndustrialSWDevelopment/code/actor-messages.scala">code/actor-messages.scala</a></div></p>
</div>
<div class="slide">
<h1>An Asynchronous (Fire and Forget) Message</h1>
<div class="code-normal">
<pre name="code" id="code" class="brush: scala;">class Manager {
  ...  
  def receive = {
    ...
    case Stop  =&gt; managedActors foreach (_ ! Stop)
    case Start =&gt; managedActors foreach (_ ! Start)
  }
}
</pre><p></div><div class="codeurl"><a href="txmt://open?url=file:///Users/dwampler/projects/Loyola/COMP388-488/Presentations/PragmaticsOfIndustrialSWDevelopment/code/actor-asynch-message.scala">code/actor-asynch-message.scala</a></div></p>
<p>If a response is required, the receiver can send a message to the sender.</p>
</div>
<div class="slide">
<h1>An Synchronous (Wait) Message</h1>
<div class="code-normal">
<pre name="code" id="code" class="brush: scala;">class Manager {
  ...  
  def receive = {
    ...
    case Stop  =&gt; managedActors foreach (_ ! Stop)
    case Start =&gt; managedActors foreach (_ ! Start)
    case Ping  =&gt; managedActors map { _ =&gt;
      (_ !! Ping).getOrElse(error(...))
    }
  }
}
</pre><p></div><div class="codeurl"><a href="txmt://open?url=file:///Users/dwampler/projects/Loyola/COMP388-488/Presentations/PragmaticsOfIndustrialSWDevelopment/code/actor-synch-message.scala">code/actor-synch-message.scala</a></div></p>
</div>
<div class="slide">
<h1>An Synchronous (Wait) Message (cont.)</h1>
<p>Has the disadvantage of blocking!</p>
</div>
<div class="slide">
<h1>An Asynchronous with a Future Message</h1>
<div class="code-normal">
<pre name="code" id="code" class="brush: scala;">def receive = {
  ...
  case Stop  =&gt; managedActors foreach (_ ! Stop)
  case Start =&gt; managedActors foreach (_ ! Start)
  case Ping =&gt; 
    val futures = managedActors map {actor =&gt;
      actor !!! Ping
    }
    Futures.awaitAll(futures)
    futures map { _.result match 
      case Some(x) =&gt; x
      case None =&gt; "Error!"
    }
}
</pre><p></div><div class="codeurl"><a href="txmt://open?url=file:///Users/dwampler/projects/Loyola/COMP388-488/Presentations/PragmaticsOfIndustrialSWDevelopment/code/actor-future-message.scala">code/actor-future-message.scala</a></div></p>
</div>
<div class="slide">
<h1>An Asynchronous with a Future Message (cont.)</h1>
<p>Actor can keep doing work (like firing off simultaneous pings).</p>
<p>Eventually, it waits for the <code>Futures</code> to complete and then proceeds. (It could also do work as each one finishes.)</p>
</div>
<div class="slide">
<h1>Another Way to Write the Last Example</h1>
<div class="code-normal">
<pre name="code" id="code" class="brush: scala;">def receive = {
  ...
  case Stop  =&gt; managedActors foreach (_ ! Stop)
  case Start =&gt; managedActors foreach (_ ! Start)
  case Ping =&gt; 
    val futures = for {     // alternative syntax
      actor &lt;- managedActors
    } yield(actor !!! Ping)
    Futures.awaitAll(futures)
    futures map { _.result match 
      case Some(x) =&gt; x
      case None =&gt; "Error!"
    }
}
</pre><p></div><div class="codeurl"><a href="txmt://open?url=file:///Users/dwampler/projects/Loyola/COMP388-488/Presentations/PragmaticsOfIndustrialSWDevelopment/code/actor-future-message2.scala">code/actor-future-message2.scala</a></div></p>
</div>
<div class="slide">
<h1>Achieving Immutability</h1>
<ul>
	<li><em>Functional languages</em> emphasize immutability.</li>
	<li>Scala encourages immutability, but also allows mutability, when needed.</li>
	<li>Declare variables as constants when possible (<code>val</code> in Scala, <code>const</code> in C/C++/C#, <code>final</code> in Java, etc.)</li>
</ul>
</div>
<div class="slide">
<h1>Introduction to the semester project</h1>
<ul>
	<li>Installing, building, and running the project skeleton.</li>
	<li>Walkthrough of major components and features.</li>
</ul>
</div>
<div class="slide">
<h1>This Week&#8217;s Assignment: Reading</h1>
<ul>
	<li>Brian Goetz, et al., Chapters 1 and 10 in &#8220;Java Concurrency in Practice&#8221; (see references &#8211; available through <a href="http://proquestcombo.safaribooksonline.com.flagship.luc.edu/">Loyola&#8217;s access to Safari Online Books</a>).</li>
	<li><em>Actor Model</em> on Wikipedia <a href="http://en.wikipedia.org/wiki/Actor_model">wikipedia.org/wiki/Actor_model</a></li>
	<li>Browse the Scala resources listed in the <a href="references.html">References</a> to learn more about Scala.</li>
	<li>Browse the Akka framework documentation at <a href="http://docs.akkasource.org">docs.akkasource.org</a>, to learn more about Akka, which is the foundation for the project code.</li>
</ul>
</div>
<div class="slide">
<h1>This Week&#8217;s Assignment: Reading (cont.)</h1>
<p>For Next Week&#8217;s Lecture:</p>
<ul>
	<li>Simon Peyton Jones, &#8220;Beautiful Concurrency&#8221;, Chapter 24 in <em>Beautiful Code</em>, pgs. 385-406. Online:  <a href="http://research.microsoft.com/en-us/um/people/simonpj/papers/stm/#beautiful">http://research.microsoft.com/en-us/um/people/simonpj/papers/stm/#beautiful</a></li>
	<li><em>Software Transactional Memory</em> (<span class="caps">STM</span>) on Wikipedia <a href="http://en.wikipedia.org/wiki/Software_transactional_memory">wikipedia.org/wiki/Software_transactional_memory</a>.</li>
</ul>
</div>
<div class="slide">
<h1>This Week&#8217;s Assignment: Project</h1>
<p>The main goal is to get the project code from GitHub, get it running, and begin to understand how it works. It&#8217;s not a trivial project to understand, especially if you&#8217;re new to Scala, but don&#8217;t be intimidated.</p>
<p>Although you won&#8217;t be asked to turn anything in next week, you should still go through the steps as far as you can, even if you don&#8217;t finish, as they will set the stage for subsequent work.</p>
</div>
<div class="slide">
<h1>Get the Project Code</h1>
<ul>
	<li>Create a personal <a href="http://github.com">GitHub</a> account, if you don&#8217;t already have one.</li>
	<li>&#8220;Fork&#8221; the project code at <a href="http://github.com/deanwampler/AkkaWebSampleExercise">github.com/deanwampler/AkkaWebSampleExercise</a></li>
	<li>Follow the instructions provided by GitHub to &#8220;clone&#8221; the code locally on your computer. For example, at your local terminal prompt, you might be asked to run the following command (in a suitable directory of your choosing):</li>
</ul>
<p><code>git clone git@github.com:myAwesomeUserName/AkkaWebSampleExercise.git</code></p>
</div>
<div class="slide">
<h1>Get the Project Code (cont.)</h1>
<ul>
	<li>We will actually do our work on &#8220;branch&#8221; called <code>COMP-388-488</code>, not the <code>master</code> branch:</li>
</ul>
<p><code>git checkout COMP-388-488</code></p>
<ul>
	<li>Type the following command to confirm you are on the correct branch:</li>
</ul>
<p><code>git branch</code></p>
<ul>
	<li>It should show the following:</li>
</ul>
<pre>
* COMP-388-488
  master
</pre>
<ul>
	<li>The <code>*</code> shows the current branch.</li>
</ul>
</div>
<div class="slide">
<h1>(Update) These steps were added after Lecture 2</h1>
<ul>
	<li>Add the following 3 lines to the end of the project&#8217;s <code>.git/config</code> file.</li>
</ul>
<div class="code-tiny">
<pre name="code" id="code" class="brush: scala,;">

[branch "COMP-388-488"]
        remote = origin
        merge = refs/heads/COMP-388-488
</pre></div>
<ul>
	<li>Run this command</li>
</ul>
<p><code>git checkout origin COMP-388-488</code></p>
</div>
<div class="slide">
<h1>(Get the Lecture Notes!)</h1>
<p>I&#8217;m also keeping the lecture notes on GitHub. Unless you want to contribute patches ;) there&#8217;s no need to fork this project.</p>
<ul>
	<li>Clone <a href="http://github.com/deanwampler/Presentations">github.com/deanwampler/Presentations</a></li>
</ul>
<p><code>git clone http://github.com/deanwampler/Presentations</code></p>
<p>You&#8217;ll see two directories:</p>
<ul>
	<li><code>akka-intro</code>: an introduction to the Akka Framework, which you might find useful since we&#8217;re using Akka for the project.</li>
	<li><code>PragmaticsOfIndustrialSWDevelopment</code>: The class notes.</li>
</ul>
</div>
<div class="slide">
<h1>(Get the Lecture Notes! &#8211; cont)</h1>
<ul>
	<li>I will update the notes in the <code>PragmaticsOfIndustrialSWDevelopment</code> directory before each class, and also upload the latest version to blackboard.</li>
	<li>See the <code>README</code> for instructions on building the presentation, or just</li>
	<li>Open <code>html/all.html</code> in your browser.</li>
</ul>
</div>
<div class="slide">
<h1>Build the Project</h1>
<ul>
	<li>Open the <code>README.md</code> file.</li>
	<li>Follow its instructions for installing MongoDB and running the project tests.</li>
	<li>Browse the code base and try to recall our discussion of it in class.</li>
</ul>
</div>
<div class="slide">
<h1>Add New Functionality</h1>
<p><strong>The instructions after this point are repeated with modifications as the homework exercise for Lecture 2, since we deferred the assignment until then. So, please go to the Lecture 2 notes, &#8220;This Week&#8217;s Assignment: Project&#8221; and proceed from there.</strong></p>
</div>
<div class="slide">
<h1>Add New Functionality</h1>
<ul>
	<li>In an editor, open the file <code>test/scala/server/finance/InstrumentAnalysisServerTest.scala</code>.</li>
	<li>Find the two <code>TODO</code> comments, one each before a <code>test</code>.</li>
	<li>In the <em>first</em> of those tests, comment out the line <code>pending</code> (like Java, you can put a <code>//</code> before the word <code>pending</code>).</li>
</ul>
</div>
<div class="slide">
<h1>Add New Functionality (cont.)</h1>
<ul>
	<li>Run the <code>test</code> action in sbt. The two tests should now fail. You should see the following near the end of the output.</li>
</ul>
<p><code>[error] Failed: : Total 96, Failed 1, Errors 0, Passed 91, Skipped 4</code></p>
<p>Try to understand the error messages:</p>
<ul>
	<li>Look for the stack trace.</li>
	<li>Ignore the verbose server messages (hint: most of those contain the words <code>akka</code> and <code>thread</code>), but notice the <code>org.scalatest.TestFailedException</code> messages.</li>
</ul>
</div>
<div class="slide">
<h1>Add New Functionality (cont.)</h1>
<p>Looking at the stack trace:</p>
<ul>
	<li>On what line <em>in the test file</em> did the failure occur? (That is, not a line in the <em>ScalaTest</em> <span class="caps">API</span>.)</li>
	<li>What did the server return and what was the expected value in those two cases? (hint: it&#8217;s a <span class="caps">JSON</span> string&#8230;)</li>
</ul>
</div>
<div class="slide">
<h1>Add New Functionality (cont.)</h1>
<ul>
	<li>In your editor, open the file <code>main/scala/server/finance/InstrumentAnalysisServer.scala</code> (the file being tested&#8230;)</li>
	<li>Find the <code>TODO</code> before the method named <code>fetchPrices</code>.</li>
	<li>This method already has the &#8220;instruments&#8221; (i.e., stocks) and statistics information.</li>
	<li>The line <code>Some(x) =&gt; filter(instruments, statistics, x)</code> takes the result from the <code>DataStorageServer</code> and passes it to a final <code>filter</code> method. Note that <code>filter</code> simply returns the <span class="caps">JSON</span> string that was passed in to it.</li>
</ul>
</div>
<div class="slide">
<h1>Add New Functionality (cont &#8211; sort of&#8230;)</h1>
<p>How could we modify <code>filter</code> to filter by instruments? (To make it easier, assume there is only one instrument in the list, as in the test.)</p>
<p>This is not easy, as we really need to parse the <span class="caps">JSON</span> into some representation, filter out the records (which are of the form <code>{"timestamp": 1283233404995, "symbol": "A", "price", "40.0"}</code>) using the <code>symbol</code>, then convert back to a string.</p>
<p>Can you figure out how to do this with the Lift <span class="caps">JSON</span> APIs used in the application and <span class="caps">JSON</span> helper types provided, or using other 3rd-party <span class="caps">JSON</span> libraries?<br />
 <br />
Actually, the right way to implement this feature is to support this filtering at the database level, which we will learn how to do with MongoDB.</p>
</div>
<div class="title slide">
<h1>Lecture 2: Scaling Computation, Part II, and Course Project Rebooted</h1>
</div>
<div class="slide">
<h1>Software Transactional Memory (<span class="caps">STM</span>)</h1>
<ul>
	<li>A concurrency model for safely mutating values.</li>
	<li>Safer alternative to lock-based concurrency.</li>
	<li>Can complement Actor concurrency.</li>
	<li>Brings database-like transactions to memory.</li>
</ul>
</div>
<div class="slide">
<h1>History: A Few Milestones</h1>
<table>
	<tr>
		<td> 1986 </td>
		<td> Tom Knight proposes hardware-based transactional memory. </td>
	</tr>
	<tr>
		<td> 1995 </td>
		<td> Nir Shavit and Dan Touitou first propose <span class="caps">STM</span>. </td>
	</tr>
	<tr>
		<td> mid-2000&#8217;s </td>
		<td> Added to Haskell. </td>
	</tr>
	<tr>
		<td> 2008 </td>
		<td> In the first release of Clojure. </td>
	</tr>
</table>
</div>
<div class="slide">
<h1>Some Notable Implementations</h1>
<table>
	<tr>
		<td> <strong>Language</strong> </td>
		<td> <strong>Name</strong> </td>
		<td> <strong>Notes</strong> </td>
	</tr>
	<tr>
		<td> Haskell </td>
		<td> <em>N.A.</em> </td>
		<td> Built into the language. Pioneering implementation copied by others. </td>
	</tr>
	<tr>
		<td> Clojure </td>
		<td> <em>N.A.</em> </td>
		<td> Built into the language. Really driving interest in <span class="caps">STM</span> and Clojure! </td>
	</tr>
	<tr>
		<td> Java and Scala</td>
		<td> Multiverse </td>
		<td> Used by Akka. </td>
	</tr>
</table>
<p>Many others listed on the <a href="http://en.wikipedia.org/wiki/Software_transactional_memory"><span class="caps">STM</span> Wikipedia page</a>.</p>
</div>
<div class="slide">
<h1><span class="caps">ACID</span></h1>
<p>Properties of <em>database</em> transactions:</p>
<ul>
	<li><strong>A</strong>: Atomicity</li>
	<li><strong>C</strong>: Consistency</li>
	<li><strong>I</strong>: Isolation</li>
	<li><strong>D</strong>: Durability</li>
</ul>
</div>
<div class="slide">
<h1>Atomicity</h1>
<p>A transaction behaves as if it happens in one, uninterruptible, &#8220;all or nothing&#8221; step.</p>
<ul>
	<li>If any <em>internal</em> step fails, the whole transaction is rolled back to the beginning state.</li>
	<li>Prevents inconsistent state changes from persisting.</li>
	<li>Transactions can fail for many reasons: bugs, resource exhaustion, process or hardware failure, etc.</li>
</ul>
</div>
<div class="slide">
<h1>Atomicity: Example</h1>
<p><strong>Scenario:</strong> A transaction T will transfer $100 from account #1, with starting balance $1100, to account #2, with starting balance $900. If successful, both accounts must have $1000.</p>
<ul>
	<li>T deducts $100 from account #1.</li>
	<li>T fails to add $100 to account #2, because it is already in another transaction.</li>
	<li>Rollback: T restores the balance of account #1 to $1100.</li>
</ul>
<p>If the transaction didn&#8217;t roll back, Account #1 would have $1000 and Account #2 would have $900.</p>
</div>
<div class="slide">
<h1>Consistency</h1>
<p>The state is always <em>consistent</em> and any transaction takes the database from one consistent state to another (as understood by the database).</p>
<p>Example consistency rules:</p>
<ul>
	<li>Types must be respected (e.g., no strings are allowed in an integer location).</li>
	<li>References to other entities must be valid. (<em>referential integrity</em>)</li>
</ul>
<p>Doesn&#8217;t cover things the database doesn&#8217;t know about, like business rules enshrined in Java&#8230;</p>
</div>
<div class="slide">
<h1>Consistency: Example</h1>
<p><strong>Scenario:</strong> A bank customer has two savings accounts, but decides to close one of them.</p>
<p>Suppose the customer records are in one database table and the account records are in a separate table. It&#8217;s common to use a third <em>join table</em> to map the relationships between M customers and N accounts.</p>
<p>So, in this scenario, the join table must be updated to remove mappings between the customer and the closed account.</p>
</div>
<div class="slide">
<h1>Side Note: Is Data Ever Deleted?</h1>
<p>In many real-world scenarios, you cannot delete data, just make it &#8220;obsolete&#8221;. The problem is that sometimes you need to undo past actions (e.g., the customer changes her mind and wants to reopen that savings account) and sometimes you need historical data for regulatory and other reasons.</p>
<p><strong>Scenario:</strong> The customer who closed one of her savings accounts wants to print out all the statements for the year, for tax purposes.</p>
<p>If you deleted the closed account, such records would be lost.</p>
</div>
<div class="slide">
<h1>Isolation</h1>
<p>Modified data in transaction A that hasn&#8217;t been committed is invisible to other transactions.</p>
<p>Necessary to preserve data integrity and consistency.</p>
</div>
<div class="slide">
<h1>Isolation: Example</h1>
<p><strong>Scenario:</strong> Two transactions want to add money to an account.</p>
<ul>
	<li>Transaction A is adding money to an account; it increases the balance, but it has not committed the change yet.</li>
	<li>Transaction B reads the balance inside transaction A and adds more money to the <em>value of transaction A&#8217;s</em> balance.</li>
	<li>A fails and roles back the balance. (So, A leaves the data in a consistent state.)</li>
	<li>B succeeds, committing its balance value, which is too high. (So, B leaves the data in an inconsistent state.)</li>
</ul>
</div>
<div class="slide">
<h1>Isolation (continued)</h1>
<p><strong>Exception:</strong> <em>Dirty Reads</em> are sometimes allowed by databases.</p>
<p>Transactions can read &#8220;in flight&#8221; data, but not modify it. Allowed in order to improve performance of concurrent transactions and to minimize potential deadlocks.</p>
</div>
<div class="slide">
<h1>Durability</h1>
<p>Committed transactions will survive system failure.</p>
<p>Often implemented with a transaction log that can be &#8220;replayed&#8221; if recovery is required.</p>
</div>
<div class="slide">
<h1>Durability: Example</h1>
<p><strong>Scenario:</strong> Money is deposited to an account, then the hard disk holding that database record crashes.</p>
<ul>
	<li>Replace the hard drive.</li>
	<li>Replay the transaction log for all transactions with data on that drive&#8230;</li>
</ul>
<p>(I&#8217;ve assumed we weren&#8217;t using <span class="caps">RAID</span> and other redundancy measures.)</p>
<p><strong>Note:</strong> The transaction is considered completed when the log entry is written!</p>
</div>
<div class="slide">
<h1>Implementing <span class="caps">ACID</span></h1>
<ul>
	<li>Locking</li>
	<li>Multiversion Concurrency Control (<span class="caps">MCC</span> or <span class="caps">MVCC</span>)</li>
</ul>
</div>
<div class="slide">
<h1>Locking</h1>
<ul>
	<li>Used when data modified <em>in place</em> (e.g., an existing row is updated).</li>
	<li>Locking of whole table or per row (typically)</li>
	<li>Must lock for reads and writes, to ensure consistency.</li>
</ul>
</div>
<div class="slide">
<h1>Multiversion Concurrency Control</h1>
<ul>
	<li>Rather than modifying existing data, make new copies.</li>
	<li>The old data is obsolete, but&#8230;</li>
	<li>&#8230; readers may wish to access the old data to get a snapshot of state at a point in time.</li>
</ul>
<ul>
	<li>So, read locks aren&#8217;t required, because all records are write-once/read-only.</li>
</ul>
</div>
<div class="slide">
<h1>Multiversion Concurrency Control (cont.)</h1>
<ul>
	<li>Note that the values are called <strong>persistent</strong>, because they don&#8217;t go away on their own (or change).</li>
	<li>Need to periodically remove old records, to save space!</li>
	<li>Copying data can be inefficient; we&#8217;ll return to this issue&#8230;</li>
</ul>
</div>
<div class="slide">
<h1>Multiversion Concurrency Control (cont.)</h1>
<p><strong>Optimistic Locking:</strong></p>
<ul>
	<li>Don&#8217;t lock to prevent others from starting transactions on the same data.</li>
	<li>When it&#8217;s time to commit, if another transaction has committed changes already (so you&#8217;re original copy is now <em>stale</em>), then fail the transaction (and usually start again).</li>
</ul>
<ul>
	<li>Each transaction has its own copy of the data.</li>
</ul>
</div>
<div class="slide">
<h1><span class="caps">MVCC</span> Failure Example</h1>
<ul>
	<li>Transaction 1 reads data values from record R.</li>
	<li>Transaction 1 begins modifications to those values.</li>
	<li>Transaction 2 reads data values from record R.</li>
	<li>Transaction 2 begins modifications to those values.</li>
	<li>Transaction 2 commits changes.</li>
	<li>Transaction 1 attempts to commit changes. Data is stale, so transaction rolls back.</li>
	<li>Repeat Transaction 1.</li>
</ul>
</div>
<div class="slide">
<h1>Costs vs. Benefits of <span class="caps">MVCC</span></h1>
<p>- Transaction failure and retry are costly, but in most systems, they&#8217;re infrequent.<br />
- Copies are costly to make; must be cleaned periodically.</p>
<p>+ No read locks.<br />
+ Optimistic locking for writes.<br />
+ Good concurrency, hence good scalability.<br />
+ Consistent state snapshots over time.</p>
</div>
<div class="slide">
<h1>Software Transactional Memory</h1>
<p>Brings the <span class="caps">ACI</span> (no D) to Memory.</p>
<ul>
	<li>No durability, by default</li>
	<li>&#8230; but some frameworks, like Akka, let you plug in durability using a database as a backing-store.</li>
	<li>Most implementations use <span class="caps">MVCC</span>.</li>
</ul>
</div>
<div class="slide">
<h1>Symantics (Using Akka Syntax)</h1>
<ul>
	<li>Separates <em>references</em> from <em>values</em>.</li>
	<li>The <em>values</em> should be immutable.</li>
	<li><strong>atomic:</strong> Marks a block controlled by <span class="caps">STM</span> where <em>refs</em> can be associated with new <em>values</em>.</li>
</ul>
<div class="code-normal">
<pre name="code" id="code" class="brush: scala;">import se.scalablesolutions.akka.stm.local._

val ref = Ref(0)        // initialize with 0
def counter = atomic {  // demarcate "atomic" block
  ref alter (_ + 1)     // change value using a function
}
 
counter  // -&gt; 1
counter  // -&gt; 2
ref.get  // -&gt; 2 (retrieve the value explicitly)</pre><p></div><div class="codeurl"><a href="txmt://open?url=file:///Users/dwampler/projects/Loyola/COMP388-488/Presentations/PragmaticsOfIndustrialSWDevelopment/code/akka-stm-example1.scala">code/akka-stm-example1.scala</a></div></p>
</div>
<div class="slide">
<h1>Symantics (cont.)</h1>
<ul>
	<li>More syntax for working with references.</li>
</ul>
<div class="code-normal">
<pre name="code" id="code" class="brush: scala;">import se.scalablesolutions.akka.stm.local._

val ten = 10
val ref = Ref(1) // initialize with 1 
atomic {  
  ref set 10     // set new value
}                // (actually returns old value)
ref.get          // -&gt; 10</pre><p></div><div class="codeurl"><a href="txmt://open?url=file:///Users/dwampler/projects/Loyola/COMP388-488/Presentations/PragmaticsOfIndustrialSWDevelopment/code/akka-stm-example2.scala">code/akka-stm-example2.scala</a></div></p>
</div>
<div class="slide">
<h1>Symantics: Blocking (&#8220;Retry&#8221;)</h1>
<ul>
	<li><strong>Retry</strong>: Block on a condition and try again when the condition is met.</li>
</ul>
<div class="code-normal">
<pre name="code" id="code" class="brush: scala;">// Inside a Transactor for bank transfers:
def receive = {
  case Transfer(from, to, amount) =&gt;
    atomic {
      if (from.get &lt; amount) {
        log.info("not enough money - retrying")
        retry  // &lt;= try again "later"
      }
      log.info("transferring")
      from alter (_ - amount)
      to alter (_ + amount)
    }
}
</pre><p></div><div class="codeurl"><a href="txmt://open?url=file:///Users/dwampler/projects/Loyola/COMP388-488/Presentations/PragmaticsOfIndustrialSWDevelopment/code/akka-stm-example3.scala">code/akka-stm-example3.scala</a></div></p>
<p>(See <strong>Blocking Transactions</strong> on the <a href="http://doc.akkasource.org/stm-scala">Akka <span class="caps">STM</span> page</a> for the full example.)</p>
</div>
<div class="slide">
<h1>Symantics: Choice (&#8220;orElse&#8221;)</h1>
<ul>
	<li><strong>Choice:</strong> When we can block on two paths, proceed when one of them becomes unblocked.</li>
</ul>
<div class="code-small">
<pre name="code" id="code" class="brush: scala;">def receive = {
  case EitherOr(left, right, action) =&gt;
    atomic {
      either {
        if (left.ok == false)
          retry
        else
          action(left)
      } orElse {
        if (right.ok == false)
          retry
        else
          action(right)        
      }
    }
}
</pre><p></div><div class="codeurl"><a href="txmt://open?url=file:///Users/dwampler/projects/Loyola/COMP388-488/Presentations/PragmaticsOfIndustrialSWDevelopment/code/akka-stm-example4.scala">code/akka-stm-example4.scala</a></div></p>
</div>
<div class="slide">
<h1>Composability and Modularity</h1>
<p>Recall in &#8220;Beautiful Concurrency&#8221;, Simon Peyton Jones described how <span class="caps">STM</span> transactions are <strong>modular</strong> in the sense that they are black boxes that can be <strong>composed</strong> to form larger transactions. <strong>Blocking</strong> and <strong>choice</strong> make this possible.</p>
</div>
<div class="slide">
<h1>Misc. Akka Syntax</h1>
<ul>
	<li>There are more features in the <span class="caps">API</span>, including configuration of implementation behavior.</li>
	<li><code>Transactors</code> are <code>Actors</code> with <span class="caps">STM</span> behavior.</li>
</ul>
</div>
<div class="slide">
<h1>Performance?</h1>
<ul>
	<li>Managing references to &#8220;snapshots&#8221; adds overhead (vs. unprotected reads and writes).</li>
	<li>Copies can be expensive&#8230;</li>
</ul>
</div>
<div class="slide">
<h1>Minimizing Copy Overhead &#8211; Trees</h1>
<p><strong>Hint:</strong> If you have a list of 200 items and you create a new version by inserting one item in the middle, the old and new versions can <em>share</em> the sublists on either side of the changed element! You can do this in a straightforward way with tree structures.</p>
<p>Here&#8217;s an example of how Clojure&#8217;s <code>PersistentVector</code> is implemented. Most STMs use similar approaches.</p>
</div>
<div class="slide">
<h1>A Value Before an Insert</h1>
<p><img src="images/persistentvector1.png"><img><br />
<br />
(credit: <a href="http://blog.higher-order.net/2009/02/01/understanding-clojures-persistentvector-implementation/">Understanding Clojures PersistentVector Implementation</a>)</div>
<div class="slide">
<h1>A Value After an Insert</h1>
<p><img src="images/persistentvector2.png"><img><br />
<br />
(credit: <a href="http://blog.higher-order.net/2009/02/01/understanding-clojures-persistentvector-implementation/">Understanding Clojures PersistentVector Implementation</a>)</div>
<div class="slide">
<h1><span class="caps">STM</span> Recap</h1>
<p>+ A very power mechanism for <em>principled</em> mutation of state.<br />
+ Cleanly separates <em>values</em> from <em>references</em> to them.<br />
+ Composable, modular transactional semantics.<br />
- Imposes some unavoidable overhead.</p>
</div>
<div class="slide">
<h1>&#8220;Memory is the New Disk&#8221;</h1>
<p><strong>1980&#8217;s &#8211; <em>Page Faulting</em>:</strong></p>
<p>When total program memory exceeded physical memory, blocks (&#8220;pages&#8221;) of memory would be swapped to disk and back again, using a least-recently used algorithm. But you wanted to avoid it because of the performance penalty. It was several orders of magnitude slower than memory access.</p>
</div>
<div class="slide">
<h1>&#8220;Memory is the New Disk&#8221; (cont.)</h1>
<p><strong>2000&#8217;s &#8211; <em>Cache Misses</em>:</strong></p>
<p>Memory, like CPUs, has also grown according to Moore&#8217;s Law, <em>but more slowly</em>. Also, bus speeds aren&#8217;t as fast as <span class="caps">CPU</span> clock speeds. So today, <strong>memory access</strong> is several orders of magnitude slower than on-chip <strong>cache</strong> access.</p>
<p>So, for optimal performance, we should <em>really</em> program to minimize cache misses.</p>
</div>
<div class="slide">
<h1>Akka Code Project Setup</h1>
<p>For the 2nd half of tonight&#8217;s class, follow the instructions in the notes for Lecture 1 to setup the project. We&#8217;ll actually work through them together in this lecture. Then I&#8217;ll describe the exercise I want you to do for next week (see notes below).</p>
</div>
<div class="slide">
<h1>This Week&#8217;s Assignment: Reading</h1>
<p>More on the underpinnings of <span class="caps">STM</span>,</p>
<ul>
	<li><a href="http://en.wikipedia.org/wiki/ACID"><span class="caps">ACID</span></a> (Wikipedia).</li>
	<li><a href="http://en.wikipedia.org/wiki/Multiversion_concurrency_control">Multiversion Concurrency Control</a> (Wikipedia). Unfortunately, the text can be a little confusing.</li>
</ul>
<p>For a more detailed look at <span class="caps">STM</span>, see this <a href="http://java.ociweb.com/mark/stm/article.html">detailed paper</a> published by <span class="caps">OCI</span>. For information on Clojure&#8217;s persistent data structures, see for example <a href="http://blog.higher-order.net/2009/02/01/understanding-clojures-persistentvector-implementation/">Understanding Clojures PersistentVector Implementation</a></p>
</div>
<div class="slide">
<h1>This Week&#8217;s Assignment: Reading (cont.)</h1>
<p>If you need more information on Scala and Akka, see the following,</p>
<ul>
	<li>My <a href="http://polyglotprogramming.com/papers/SeductionsOfScala.pdf">Seductions of Scala</a> presentation. It should fill in a few Scala gaps. <strong><span class="caps">NOTE</span>:</strong> I am presenting this talk at the September 16th <a href="http://meetup.com/chicagoscala">Chicago Scala User&#8217;s Group</a> (<span class="caps">RSVP</span> required).</li>
	<li><a href="http://www.naildrivin5.com/scalatour/wiki_pages/MainPage">Another Tour of Scala</a>.</li>
	<li>This presentation on Akka: <a href="http://www.slideshare.net/jboner/akka-scala-summit-oscon-2010">slideshare.net/jboner/akka-scala-summit-oscon-2010</a>, which is also shown on the home page for the Akka Documentation: <a href="http://doc.akkasource.org">doc.akkasource.org</a>. See in particular the discussion of how actors, agents, and <span class="caps">STM</span> work in Akka.</li>
</ul>
<p>For more on Scala and Akka, see the Scala and Akka sections in the <a href="references.html">References</a>.</p>
</div>
<div class="slide">
<h1>This Week&#8217;s Assignment: Reading (cont.)</h1>
<ul>
	<li><a href="http://en.wikipedia.org/wiki/Distributed_computing">Distributed Computing</a>. Focus on the Introduction, History, Applications, and Architectures sections.</li>
</ul>
</div>
<div class="slide">
<h1>This Week&#8217;s Assignment: Project</h1>
<p>Complete the setup instructions in Lecture 1 that we went through this evening.</p>
<ul>
	<li>The <code>sbt update</code> command should be successful with no errors.</li>
	<li>MongoDB should be installed and you should know how to start and stop it.</li>
	<li>The <code>sbt test</code> command should work with no test failures.</li>
</ul>
</div>
<div class="slide">
<h1>This Week&#8217;s Assignment: Project</h1>
<p>Work the suggested exercise from last week, but with the refinements I will describe now. I have repeated that section from the notes, with the changes I want you to do, in very specific detail (since I know most of you are new to Scala, as well as new to this code). Reminder: You are welcome to work on this assignment with your class mates.</p>
<p>However, this week, I would like you to commit your changes to your cloned git repository on GitHub. I&#8217;ll tell you how at the end of the instructions.</p>
</div>
<div class="slide">
<h1>Add New Functionality</h1>
<p>(Adapted from the Lecture 1 notes.)</p>
<ul>
	<li>In an editor, open the file <code>test/scala/server/finance/InstrumentAnalysisServerTest.scala</code>.</li>
	<li>Find the two <code>TODO</code> comments, one each before a <code>test</code>.</li>
	<li>In the <em>first</em> of those tests, comment out the line <code>pending</code> (like Java, you can put a <code>//</code> before the word <code>pending</code>).</li>
</ul>
</div>
<div class="slide">
<h1>Add New Functionality (cont.)</h1>
<ul>
	<li>Run the <code>test</code> action in sbt. The two tests should now fail. You should see the following near the end of the output.</li>
</ul>
<p><code>[error] Failed: : Total 110, Failed 1, Errors 0, Passed 104, Skipped 5</code></p>
<p>Try to understand the error messages:</p>
<ul>
	<li>Look for the stack trace.</li>
	<li>Ignore the verbose server messages (hint: most of those contain the words <code>akka</code> and <code>thread</code>), but notice the <code>org.scalatest.TestFailedException</code> messages.</li>
</ul>
</div>
<div class="slide">
<h1>Add New Functionality (cont.)</h1>
<p>When you find the stack trace, <em>above</em> it is this output:</p>
<div class="code-tiny">
<pre name="code" id="code" class="brush: scala;">[error] Test Failed: calculateStatistics returns a JSON string containing all data that matches the instrument criteria
org.scalatest.TestFailedException: JObject(List(JField(criteria,JObject(List(JField(instruments,JArray(List(JString(A)))), JField(statistics,JArray(List(JString(price[$])))), JField(start,JInt(0)), JField(end,JInt(1283824964864))))), JField(results,JArray(List(JObject(List(JField(timestamp,JInt(1283824954864)), JField(symbol,JString(A)), JField(price,JDouble(0.0)))), JObject(List(JField(timestamp,JInt(1283824955864)), JField(symbol,JString(C)), JField(price,JDouble(10.0)))), JObject(List(JField(timestamp,JInt(1283824956864)), JField(symbol,JString(A)), JField(price,JDouble(20.0)))), JObject(List(JField(timestamp,JInt(1283824957864)), JField(symbol,JString(B)), JField(price,JDouble(30.0)))), JObject(List(JField(timestamp,JInt(1283824958864)), JField(symbol,JString(A)), JField(price,JDouble(40.0))))))))) did not equal JObject(List(JField(criteria,JObject(List(JField(instruments,JArray(List(JString(A)))), JField(statistics,JArray(List(JString(price[$])))), JField(start,JInt(0)), JField(end,JInt(1283824964864))))), JField(results,JArray(List(JObject(List(JField(timestamp,JInt(1283824954864)), JField(symbol,JString(A)), JField(price,JDouble(0.0)))), JObject(List(JField(timestamp,JInt(1283824958864)), JField(symbol,JString(A)), JField(price,JDouble(40.0)))), JObject(List(JField(timestamp,JInt(1283824956864)), JField(symbol,JString(A)), JField(price,JDouble(20.0)))))))))
</pre><p></div><div class="codeurl"><a href="txmt://open?url=file:///Users/dwampler/projects/Loyola/COMP388-488/Presentations/PragmaticsOfIndustrialSWDevelopment/code/exercise1-test-failure.scala">code/exercise1-test-failure.scala</a></div></p>
<p>(Yeah!)</p>
</div>
<div class="slide">
<h1>Add New Functionality (cont.)</h1>
<p>This is <span class="caps">JSON</span> represented using the Scala <span class="caps">JSON</span> library that is part of the <a href="http://liftweb.net">Lift Web framework</a> (which the project uses). I find it easiest to copy and paste messy output like this to an editor where I can manipulate it&#8230;</p>
<p>But we don&#8217;t really need to do that now. Look for the words <code>did not equal</code>. The &#8220;<span class="caps">JSON</span>&#8221; before these words is much longer than the &#8220;<span class="caps">JSON</span>&#8221; after them. The before case is what was actually returned, while the after case is what we expected. Recall the purpose of the test, to confirm that the results are filtered for just the <code>A</code> stocks. Look for these strings: <code>JField(instruments,JArray(List(JString(A)))</code>. The <code>A</code> is the instrument (stock symbol). The expected string only has <code>A</code> &#8220;fields&#8221;, while the actual also has <code>B</code> and <code>C</code> fields, too.</p>
</div>
<div class="slide">
<h1>Add New Functionality (cont.)</h1>
<p>Now look again at the stack trace:</p>
<ul>
	<li>On what line <em>in the test file</em> did the failure occur? (That is, not a top line, which occurred in the <em>ScalaTest</em> <span class="caps">API</span>.)</li>
</ul>
<p>That line is 112 (at the time of this writing&#8230;). That line in <code>test/scala/server/finance/InstrumentAnalysisServerTest.scala</code> is</p>
<div class="code-tiny">
<pre name="code" id="code" class="brush: scala,;">

analysisServer.calculateStatistics(criteria) should equal (expected)
</pre></div>
<p>Note how this <em>test assertion</em> reads like English? The result of &#8220;calling the <code>calculateStatistics</code> method should equal the <code>expected</code> value&#8221;.</p>
</div>
<div class="slide">
<h1>Add New Functionality (cont.)</h1>
<ul>
	<li>Okay, to start adding new functionality, run this <code>sbt</code> command:</li>
</ul>
<p><code>~test-only org.chicagoscala.awse.server.finance.InstrumentAnalysisServerTest</code></p>
<ul>
	<li>Note that it will wait (no prompt is returned) and every time you save code changes, this test will run.</li>
	<li>Using the <code>~test-only</code> &#8220;action&#8221; saves time, running in a few seconds, while running all the tests takes longer.<br />
 <br />
</div><br />
<div class="slide"></li>
</ul>
<h1>Add New Functionality (cont.)</h1>
<ul>
	<li>Now, in your editor of choice, open the file <code>main/scala/server/finance/InstrumentAnalysisServer.scala</code> (the file being tested&#8230;)</li>
	<li>Find the <code>TODO</code> before the method named <code>fetchPrices</code>.</li>
	<li>This method already has the &#8220;instruments&#8221; (i.e., stocks) and statistics information.</li>
</ul>
</div>
<div class="slide">
<h1>Add New Functionality (cont.)</h1>
<ul>
	<li>Find this line:</li>
</ul>
<div class="code-tiny">
<pre name="code" id="code" class="brush: scala,;">

formatPriceResults(filter(result), instruments, statistics, startMillis, endMillis)
</pre></div>
<ul>
	<li>Then find the <code>filter</code> method below it. Note that it takes a <code>(json: JValue)</code> (i.e., a variable named <code>json</code> of type <code>JValue</code>) and it simply returns the passed-in value unaltered.</li>
	<li>Your task is to add filtering by instruments.</li>
</ul>
</div>
<div class="slide">
<h1>Add New Functionality (cont.)</h1>
<ul>
	<li>Note the <code>instruments</code> argument passed to <code>fetchPrices</code>; add this argument to the <code>filter</code> method.</li>
	<li>Modify the call to <code>filter</code> to pass the <code>instruments</code>.</li>
	<li>Replace the body of <code>filter</code> (everything after the <code>=</code> sign) with this body:</li>
</ul>
<div class="code-tiny">
<pre name="code" id="code" class="brush: scala,;">

{  val names = Instrument.toSymbolNames(instruments)
  // log.error ("json: "+json.toString)
  // log.error ("json.values: "+json.values.toString)
  // log.error ("symbol: "+(json \\ "symbol").toString)
  json match {
    case JArray(list) =&gt; list filter { element =&gt; 
      (element \\ "symbol") match {
        case JField("symbol", x) if (names.exists(x == JString(_))) =&gt; true
        case _ =&gt; false
      }
    }
    case _ =&gt; true
  }
}
</pre></div>
</div>
<div class="slide">
<h1>Add New Functionality (cont.)</h1>
<ul>
	<li>Now the test should be passing (showing <code>[success] Successful</code>).</li>
	<li>Hit return to exit <code>~test-only</code> and run all the tests (<code>test</code>) and confirm that they all now pass.</li>
</ul>
</div>
<div class="slide">
<h1>Add New Functionality (cont.)<br />
 <br />
You may not understand what this method is doing. It&#8217;s actually quite sophisticated and relies on very specific knowledge about the underlying format of the <code>json: JValue</code>. In fact, the correct way to implement this feature is to support this filtering at the database level, which we will learn how to do with MongoDB. This approach is both more efficient (we don&#8217;t waste time returning stuff we&#8217;ll throw away), more flexible, and more robust.</h1>
<p>Note that I added some <code>log.error</code> statements in comments. Try running the <code>~test-only</code> command again and uncomment those lines. Try to find them in all the noisy output. Do they help you understand what&#8217;s going on? Look at the Lift <span class="caps">JSON</span> documentation to further understand this <span class="caps">API</span>. It is here: <a href="http://main.scala-tools.org/mvnsites/liftweb-2.0/framework/scaladocs/index.html">scala-tools.org/mvnsites/liftweb-2.0/framework/scaladocs/index.html</a> (Hint: click the <code>net.liftweb.json</code> link to focus in on the <span class="caps">JSON</span> part of the <span class="caps">API</span>.)</p>
</div>
<div class="slide">
<h1>Turning in the Assignment</h1>
<p>Before class next week, 6/14, commit your code changes to GitHub, using these commands.</p>
<p>First make sure you don&#8217;t have any changes that aren&#8217;t checked in.</p>
<ul>
	<li><code>git status</code></li>
</ul>
<p>If you added any new files to the project (unlikely) and you see them listed in the section labeled <code># Untracked files:</code>, then <em>add</em> those files to git (<strong>Note: ignore the <code>logs</code> and <code>data</code> directories!</strong>):</p>
<ul>
	<li><code>git add files_to_be_added</code></li>
</ul>
<p>Where <code>files_to_be_added</code> is the list of new files to add.</p>
</div>
<div class="slide">
<h1>Turning in the Assignment (cont.)</h1>
<p>In the status output, you might see files in the section labeled <code># Changed but not updated:</code>. These are files where you&#8217;ve made local changes, but not yet checked them in. If so, checkin those files to your <em>local</em> repository now.</p>
<ul>
	<li><code>git checkin -m 'appropriate comment' files</code></li>
</ul>
<p>You can either list the <code>files</code> or omit the list, in which case <em>all</em> the files with changes will be checked in.</p>
</div>
<div class="slide">
<h1>Turning in the Assignment (cont.)</h1>
<p>Finally, <em>push</em> your local repository changes to the copy on GitHub.</p>
<ul>
	<li><code>git push</code></li>
</ul>
<p>You&#8217;ll see some output, but no error messages.</p>
<p>When finished, send me email. Also, tell me your username on GitHub, so I&#8217;ll know who owns which <em>forks</em> of the project.</p>
<p>Again, if you have any problems with these steps, let me know. We can go over them next week in class, too, if necessary.</p>
</div>
<div class="title slide">
<h1>Lecture 3: Scaling Systems, Part I</h1>
</div>
<div class="slide">
<h1>Some Terms &#8224;</h1>
<div class='medium'>
<ul>
	<li><strong>Client:</strong> A person or other <em>service</em> that uses a provided <em>service</em>.</li>
	<li><strong>Process:</strong> An operating system process.</li>
	<li><strong>Component:</strong> A &#8220;course grained&#8221; HW or SW entity. SW <em>components</em> are in the same <em>process</em>.</li>
	<li><strong>Service:</strong> One or more <em>processes</em> and <em>components</em> that provide a subset of <em>system services</em>.</li>
	<li><strong>Network Node:</strong> A discrete server that provides <em>services</em> to other <em>network nodes</em>.</li>
	<li><strong>System:</strong> The well defined collection of <em>components</em>, <em>services</em>, and <em>network nodes</em>.</li>
	<li><strong>System Point:</strong> Some logically-discrete part of an overall <em>system</em>. Depending on the context, it might be a <em>component</em>, <em>service</em>, or <em>network node</em>.</li>
</ul>
<p>&#8224; Warning, some of these terms are vague; they don&#8217;t have standard definitions!</p>
</div>
</div>
<div class="slide">
<h1>Some Ways that Systems Fail</h1>
<ul>
	<li><em>Single points of failure.</em></li>
	<li>Poor fault tolerance (resiliency).</li>
	<li>Insufficient resources.</li>
	<li>Poor security.</li>
</ul>
<p>And affecting long-term business growth&#8230;</p>
<ul>
	<li>Complexity makes evolution difficult.</li>
</ul>
</div>
<div class="slide">
<h1>Single Point of Failure (<span class="caps">SPOF</span>)</h1>
<p><em>A point in a system where a failure would cause the whole system to fail.</em></p>
<p>Examples:</p>
<ul>
	<li><span class="caps">CPU</span>, <span class="caps">RAM</span>, disk, network interface, power&#8230;</li>
	<li>Logical &#8220;tiers&#8221; and components:
	<ul>
		<li>Database</li>
		<li>Middle-tier server</li>
		<li>Other network service</li>
	</ul></li>
</ul>
</div>
<div class="slide">
<h1>Poor Fault Tolerance (Resiliency)</h1>
<p><strong>Fault Tolerance:</strong> <em>How well a system continues to provide service if part of it fails or bad data is received.</em></p>
<p>Systems can be vulnerable even if they don&#8217;t have any single points of failure.</p>
<p>Examples:</p>
<ul>
	<li>A database or other service query returns &#8220;invalid&#8221; data.</li>
	<li>A Browser with JavaScript disabled tries to display a page that relies on JavaScript.</li>
	<li>Bad user input!</li>
	<li>Software bugs!</li>
</ul>
</div>
<div class="slide">
<h1>Poor Fault Tolerance (Resiliency) cont.</h1>
<p>The system should <em>degrade gracefully</em>.</p>
<p>Note that performance might suffer, even if a fault is tolerated.</p>
<p>You&#8217;ll hear <em>stability</em> and <em>reliability</em> also used for essentially the same concept.</p>
</div>
<div class="slide">
<h1>Insufficient Resources</h1>
<p><em>The system can&#8217;t meet the demands for service.</em></p>
<p><strong>Symptom:</strong> The system can&#8217;t service all clients within an acceptable window of opportunity, usually because there are too many concurrent clients!</p>
<p>Examples <em>Bottlenecks</em>:<br />
<div class='small'></p>
<ul>
	<li>Disk or memory space.</li>
	<li>Network bandwidth.</li>
	<li>Database transaction throughput.</li>
	<li>Computation speed.</li>
	<li>Physical space! (i.e., enough room to add more &#8220;stuff&#8221;)<br />
</div></li>
</ul>
</div>
<div class="slide">
<h1>Poor Security</h1>
<p><em>Systems connected to the Internet are more vulnerable than closed systems.</em></p>
<p>&#8230; but security breaches &#8220;from the inside&#8221; are also significant.</p>
<ul>
	<li>Malicious users.</li>
	<li>Unwitting users.</li>
</ul>
</div>
<div class="slide">
<h1>Complexity Makes Evolution Difficult</h1>
<p><em>A poorly structured system is difficult to extend to support new functionality.</em></p>
<p>Example Sources of Complexity:</p>
<ul>
	<li>Source code.</li>
	<li>System <em>topology</em>.
	<ul>
		<li>How logical work is divided amongst <em>components</em>, <em>services</em>, and <em>network nodes</em>.</li>
	</ul></li>
	<li>Excessive coupling between <em>service points</em>.</li>
	<li>Too <em>little</em> distribution (i.e., single <em>service points</em> with too many responsibilities tend to be overly complex).</li>
</ul>
</div>
<div class="slide">
<h1>Large-scale System Design Concerns</h1>
<ul>
	<li>Scalability</li>
	<li>Availability</li>
	<li>Security:
	<ul>
		<li>Authentication</li>
		<li>Authorization</li>
	</ul></li>
</ul>
</div>
<div class="slide">
<h1>Scalability</h1>
<p><em>Can the system&#8217;s capacity be increased at reasonable cost?</em></p>
<p>Affects the ability to provide adequate resources to meet service expectations.</p>
<p>Consider <em>latency</em> vs. <em>throughput</em>, using a pipe analogy:</p>
<ul>
	<li><strong>Latency:</strong> The time it takes for any one computation. Imagine the pipe is <em>long</em> or <em>short</em>.</li>
	<li><strong>Throughput:</strong> The amount of computation per unit time. Imagine the pipe is <em>fat</em> or <em>thin</em>.</li>
</ul>
</div>
<div class="slide">
<h1>Scalability (cont.)</h1>
<p>Two ways to Scale:</p>
<ul>
	<li>Scale <em>vertically</em>.</li>
	<li>Scale <em>horizontally</em>.</li>
</ul>
</div>
<div class="slide">
<h1>Scaling Vertically</h1>
<p>Adding more hardware to the <em>same</em> machine.</p>
<ul>
	<li><strong>Easy:</strong> Requires no software changes, no increase in &#8220;rack&#8221; space, etc.</li>
	<li><strong>Expensive:</strong> Premium price for the top-of-the-line hardware.</li>
	<li><strong><span class="caps">SPOF</span>:</strong> The server remains a single point of failure</li>
</ul>
</div>
<div class="slide">
<h1>Scaling Horizontally</h1>
<p>Adding more hardware <em>in parallel</em>.</p>
<ul>
	<li><strong>Hard:</strong> May require significant software changes.</li>
	<li><strong>Cheap:</strong> Can use lower-cost hardware (but more power and space?).</li>
	<li><strong><span class="caps">SPOF</span> Elimination:</strong> <em>Redundancy</em> eliminates <span class="caps">SPOF</span> (in principle&#8230;)</li>
</ul>
</div>
<div class="slide">
<h1>Redundancy</h1>
<ul>
	<li>N &gt; 1 identical <em>components</em>, <em>services</em>, or <em>network nodes</em>.</li>
	<li>Enables <em>failover</em> when one element fails.</li>
</ul>
</div>
<div class="slide">
<h1>&#8220;Let It Crash&#8221;</h1>
<p>A core philosophy in Akka, Erlang, and many other Actor-based systems. Rather than create big processes that require complex error recovery (which is very hard to do well&#8230;), use lots of small &#8220;workers&#8221; that are expendable. If any one of them gets into trouble, let it crash and restart it.</p>
<p>Requires careful partitioning and supervision of work, including tolerance for small failures.</p>
</div>
<div class="slide">
<h1>Distribution of Computation and Data</h1>
<ul>
	<li>HW and SW can be tuned for specific services.
	<ul>
		<li>E.g., The database servers have different performance requirements than the servers that deliver static web content (images, videos, JavaScript, &#8230;).</li>
	</ul></li>
	<li>Data can be divided.
	<ul>
		<li>Disk <em>striping</em> (e.g., <span class="caps">RAID</span>-5 disk arrays). Gives both scalability (N disk drives) plus failure resiliency (data is effectively duplicated across the array). Disk array configurations can also parallelize writes, increasing <em>throughput</em>.</li>
		<li>Database <em>sharding</em> (e.g., all East-coast customers in the New York data center). Data is separated, not duplicated (use <em>replication</em> for that&#8230;)</li>
	</ul></li>
</ul>
</div>
<div class="slide">
<h1>Caching</h1>
<p><em>Remembering the result of an expensive operation for subsequent use.</em></p>
<ul>
	<li><strong>Data Caching:</strong>
	<ul>
		<li><em>In-memory</em> cache speeds up <em>disk</em> I/O.</li>
		<li><em><span class="caps">CPU</span></em> cache speeds up <em>memory</em> I/O.</li>
	</ul></li>
</ul>
<ul>
	<li><strong>Memoization:</strong>
	<ul>
		<li>Remembering the result of a previous <em>calculation</em>.</li>
	</ul></li>
</ul>
</div>
<div class="slide">
<h1>Availability</h1>
<p><em>Can the system provide service when clients expect it?</em></p>
<p>Subject to the <em>service level agreements</em> (SLAs) with clients about when service is required: 24&#215;7? 8-5 week days? holidays? (Performance is usually part of SLAs, too.)</p>
<p>Requires <em>fault tolerance</em>.</p>
</div>
<div class="slide">
<h1>Availability Numbers</h1>
<table class="tiny">
	<tr>
		<th>Availability&#160;% </th>
		<th>Downtime/Year  </th>
		<th>Downtime/Month </th>
		<th>Downtime/Week </th>
	</tr>
	<tr>
		<td> 90% (&#8220;one nine&#8221;)  </td>
		<td> 36.5 days  </td>
		<td> 72 hours  </td>
		<td> 16.8 hours  </td>
	</tr>
	<tr>
		<td> 95%  </td>
		<td> 18.25 days  </td>
		<td> 36 hours  </td>
		<td> 8.4 hours  </td>
	</tr>
	<tr>
		<td> 98%  </td>
		<td> 7.30 days  </td>
		<td> 14.4 hours  </td>
		<td> 3.36 hours  </td>
	</tr>
	<tr>
		<td> 99% (&#8220;two nines&#8221;)  </td>
		<td> 3.65 days  </td>
		<td> 7.20 hours  </td>
		<td> 1.68 hours  </td>
	</tr>
	<tr>
		<td> 99.5%  </td>
		<td> 1.83 days  </td>
		<td> 3.60 hours  </td>
		<td> 50.4 minutes  </td>
	</tr>
	<tr>
		<td> 99.8%  </td>
		<td> 17.52 hours  </td>
		<td> 86.23 minutes  </td>
		<td> 20.16 minutes  </td>
	</tr>
	<tr>
		<td> 99.9% (&#8220;three nines&#8221;)  </td>
		<td> 8.76 hours  </td>
		<td> 43.2 minutes  </td>
		<td> 10.1 minutes  </td>
	</tr>
	<tr>
		<td> 99.95%  </td>
		<td> 4.38 hours  </td>
		<td> 21.56 minutes  </td>
		<td> 5.04 minutes  </td>
	</tr>
	<tr>
		<td> 99.99% (&#8220;four nines&#8221;)  </td>
		<td> 52.56 minutes  </td>
		<td> 4.32 minutes  </td>
		<td> 1.01 minutes  </td>
	</tr>
	<tr>
		<td> 99.999% (&#8220;five nines&#8221;)  </td>
		<td> 5.26 minutes  </td>
		<td> 25.9 seconds  </td>
		<td> 6.05 seconds  </td>
	</tr>
	<tr>
		<td> 99.9999% (&#8220;six nines&#8221;)  </td>
		<td> 31.5 seconds  </td>
		<td> 2.59 seconds  </td>
		<td> 0.605 seconds  </td>
	</tr>
	<tr>
		<td> 99.999999% (&#8220;nine nines&#8221;)  </td>
		<td> 31.5 microseconds  </td>
		<td> 2.59 microseconds  </td>
		<td> 0.605 microseconds  </td>
	</tr>
</table>
<p>(adapted from http://en.wikipedia.org/wiki/High_availability)</p>
</div>
<div class="slide">
<h1>Achieving High Availability</h1>
<ul>
	<li><strong>Redundancy:</strong> Improves fault tolerance (e.g., <span class="caps">SPOF</span> elimination).</li>
	<li><strong>Resource Planning:</strong> Estimating <em>and measuring</em> resource utilization. Avoidance of high % utilization.</li>
	<li><strong>Other Fault Tolerance Design Concerns:</strong>
	<ul>
		<li>Clock Synchronization</li>
		<li>Consensus</li>
		<li>Self Stabilization</li>
	</ul></li>
</ul>
</div>
<div class="slide">
<h1>Clock Synchronization</h1>
<p><em>When the <strong>timing of events</strong> matters across different systems, how do you ensure that those systems have synchronized clocks?</em></p>
<p>Examples:</p>
<ul>
	<li>Message queues.</li>
	<li>Log monitoring.</li>
</ul>
</div>
<div class="slide">
<h1>Consensus</h1>
<p><em>How do you decide which systems are correct if answers that should be the same are different?</em></p>
<p>There are four, redundant flight-control computers on the space shuttle:<br />
<br/></p>
<blockquote>
<p>The four general-purpose computers operate essentially in lockstep, checking each other. If one computer fails, the three functioning computers &#8220;vote&#8221; it out of the system. This isolates it from vehicle control. If a second computer of the three remaining fails, the two functioning computers vote it out. In the rare case of two out of four computers simultaneously failing (a two-two split), one group is picked at random.<br />
(from the <a href="http://en.wikipedia.org/wiki/Space_Shuttle">Space Shuttle Wikipedia page</a>)</p>
</blockquote>
</div>
<div class="slide">
<h1>Self Stabilization</h1>
<p>Trying to &#8220;engineer-in&#8221; correctness in a distributed system is essentially impossible. Instead, design the system so it <em>constantly drives itself towards stability</em>.</p>
<p>This may or may not involve actual detection of errors.</p>
</div>
<div class="slide">
<h1>Security</h1>
<ul>
	<li><strong>Authentication:</strong> Reliably identifying a client (user or external system) attempting to use system resources.</li>
	<li><strong>Authorization:</strong> Once a client is authenticated, controlling access to those resources for which the client is permitted to use.</li>
</ul>
</div>
<div class="slide">
<h1>Topologies</h1>
<ul>
	<li>Client–server (2-tier) architecture</li>
	<li>3-tier architecture</li>
	<li>N-tier architecture</li>
	<li>Tightly coupled (clustered)</li>
	<li>Peer-to-peer</li>
	<li>Space based</li>
</ul>
</div>
<div class="slide">
<h1>Client–server (2-tier) Architecture</h1>
<p>A client requests data or work from a server, or sends data updates to a server. The client then formats and presents the results to the user. Often, the server is a database and the client implements non-trivial &#8220;business domain logic&#8221; (business logic, for short).</p>
<p>Note that <em>tier</em> often implies a vertical orientation; <em>client down to server and back up to client</em>.</p>
<p>Examples:</p>
<ul>
	<li>Typical VisualBasic apps.</li>
	<li>Simpler, low-volume web applications.</li>
</ul>
</div>
<div class="slide">
<h1>3-tier Architecture</h1>
<p>A presentation tier, a middle tier handling &#8220;business logic&#8221;, and a database (persistence) tier. The middle tier implements most of the logic that would be in the client and some of the logic that would be in the &#8220;server&#8221; (database?) in a 2-tier system.</p>
<ul>
	<li>The &#8220;standard&#8221; architecture of mid-sized, mid-volume Internet and IT systems.</li>
	<li>Having three tiers simplifies the responsibilities of each tier, compared to 2-tier systems.
	<ul>
		<li>Putting logic in the UI is bad because it&#8217;s hard to test and it doesn&#8217;t cleanly separation &#8220;concerns&#8221;.</li>
	</ul></li>
</ul>
</div>
<div class="slide">
<h1>N-tier Architecture</h1>
<p>Generalization of 3-tier architecture. There may be more than 3 vertical tiers, but often there are <em>horizontal</em> (peer) services that separate responsibilities, usually only at the mid tier and persistence &#8220;levels&#8221; (but the UI should be <em>componentized</em>).</p>
<p>Typical of all high-volume, high-availability web sites and IT applications.</p>
<p>Examples:</p>
<ul>
	<li>Cloud computing</li>
	<li>Email?</li>
</ul>
</div>
<div class="slide">
<h1>Tightly Coupled (Clustered)</h1>
<p>Usually refers to a cluster of servers or services that collaborate closely, perhaps to solve a problem with <em>divide and conquer</em> after which the individual contributions are combined to produce the final result.</p>
<p>Tight coupling may imply that failure of one element causes the work of all elements to fail. An exception is typical <em>map-reduce</em> systems (which we&#8217;ll discuss in a subsequent lecture), like <em>Hadoop</em>, which handle single node failures.<br />
 <br />
Example:</p>
<ul>
	<li>Multicore Processor</li>
	<li>Map-Reduce</li>
</ul>
</div>
<div class="slide">
<h1>Master-Slave</h1>
<p>An arrangement where one system dictates the work performed by subordinate systems.</p>
<p>Also used for arrangements of similar systems where one system is designated the primary source of data and/or computation (the &#8220;master&#8221;), but work may <em>fail over</em> to a backup (&#8220;slave&#8221;) system if the master fails. The slave(s) may have to do all the work the master does (e.g., store data records) in order to take over. <em>Primary-secondary</em> is sometimes used to describe this arrangement.</p>
<p>The slave is now considered the master. After recovery, the old master may re-enter the system as a slave (or become the master again).</p>
<p>Example:</p>
<ul>
	<li>Datebase master-slave server</li>
</ul>
</div>
<div class="slide">
<h1>Peer-to-peer</h1>
<p>In contrast to <em>master-slave</em>, an architecture where no one system has a special role relative to the others in a group that provides a service. No one system directs the work of others, either. Rather, all systems divide the responsibilities equally, as <em>peers</em>, including the management of work.</p>
<p>Example:</p>
<ul>
	<li><em>Mesh</em> network</li>
</ul>
</div>
<div class="slide">
<h1>Space Based</h1>
<p>An infrastructure that creates the illusion of one single address-space. Data (and sometimes code!) are transparently replicated among &#8220;physical&#8221; elements. Sometimes called <em>virtualization</em> (but that has other meanings, too).</p>
<p>Examples:</p>
<ul>
	<li>Terracotta &#8211; Virtualization of data across <span class="caps">JVM</span> instances.</li>
	<li>Tuple spaces &#8211; e.g., Linda</li>
</ul>
</div>
<div class="slide">
<h1>Examples of Distributed Systems and Applications</h1>
<p>For more examples, see the list on the <a href="http://en.wikipedia.org/wiki/Distributed_computing">Distributed Computing</a> Wikipedia page.</p>
</div>
<div class="slide">
<h1>Scaling Systems, Part II</h1>
<p>We&#8217;ll return to <em>Scaling Systems</em> next month after the Midterm. For the next few weeks, we&#8217;ll focus on <span class="caps">SQL</span> and <em>NoSQL</em> databases.</p>
</div>
<div class="slide">
<h1>Reading Assignments:</h1>
<ul>
	<li><a href="http://www.slideshare.net/jboner/scalability-availability-stability-patterns">Scalability, Availability, Stability Patterns</a>. A (long) presentation that covers many essentials of building systems that satisfy requirements we&#8217;ve discussed. It also discusses <em>NoSQL</em> databases that we&#8217;ll explore in subsequent weeks. Some of the other concepts discussed (like immutability and referential transparency) will be discussed later in the course. Skim the sections on data flow concurrency and event processing approaches; we won&#8217;t cover them in the course. I also don&#8217;t expect you to remember the lists of products in each category!</li>
	<li><a href="http://blog.heroku.com/archives/2010/7/20/nosql/">NoSQL, Heroku, and You</a>. One cloud service vendor&#8217;s take on the importance of NoSQL databases.</li>
</ul>
</div>
<div class="slide">
<h1>For Further Research</h1>
<ul>
	<li>Diomidis Spinellis and Georgios Gousios, &#8220;Beautiful Architecture&#8221;, O&#8217;Reilly, 2009. <span class="caps">ISBN</span>: 0596517984. Good essays on architecture.</li>
	<li><a href="http://en.wikipedia.org/wiki/Consensus_(computer_science">Consensus</a>).</li>
	<li><a href="http://en.wikipedia.org/wiki/Self-stabilisation">Self Stabilization</a>.</li>
	<li><a href="http://en.wikipedia.org/wiki/Byzantine_fault_tolerance">Byzantine fault tolerance</a>.</li>
	<li>Martin Fowler, et al., &#8220;Patterns of Enterprise Application Architecture&#8221;, Addison-Wesley, 2003. <span class="caps">ISBN</span>: 0321127420. Conventional, object-oriented approach. Does not cover the latest thinking on highly-distributed architectures.</li>
</ul>
</div>
<div class="slide">
<h1>Add New Functionality (step 1)</h1>
<p>This week, we&#8217;ll finally add the <span class="caps">NYSE</span> data to the project.</p>
<p>Make sure you have pulled the latest changes from the project on the <code>COMP-388-488</code> branch.</p>
<p>Open the <code>README.md</code> file (it&#8217;s nicely formatted on GitHub) and follow the directions in the newly-revised section called <strong>Import the Data</strong>. It explains the new scripts in the <code>bin</code> directory (which we&#8217;ll also discuss in class) that you use to import the data.</p>
<p>After importing the data, read the next section on using the web app, which explains a few things you&#8217;ll need to know for the current state of the project.</p>
</div>
<div class="slide">
<h1>Add New Functionality (step 2)</h1>
<p>Note that the instructions mention a <code>datatmp</code> directory that holds temporary <span class="caps">JSON</span> files that were generated from the original <span class="caps">YAML</span> files and imported into MongoDB. These <span class="caps">JSON</span> files contain one-line <span class="caps">JSON</span> expressions as required by <code>mongoimport</code>. Once the data import is done and the <code>mongo</code> console commands suggested in the <span class="caps">README</span> work correctly, you can delete <code>datatmp</code>.</p>
</div>
<div class="slide">
<h1>Add New Functionality (step 3)</h1>
<p>For our next exercise (#2), we&#8217;ll answer the question, &#8220;What stocks are available?&#8221;. We&#8217;ll add a feature that returns the available stock symbols.</p>
<p>There is a new branch on the GitHub project, based on <code>COMP-388-488</code>, called <code>exercise2</code>. run these commands, where the <code>#...</code> are comments:</p>
<div class="code-tiny">
<pre name="code" id="code" class="brush: bash,;">

git fetch                        # grab the latest off GitHub, but don't merge changes
git branch -a                    # Show all the local and remote branches
git log origin/COMP-388-488 ^COMP-388-488  # show me what's changed!
git checkout COMP-388-488        # move to this branch (if not already there)
git merge origin/COMP-388-488    # merge to my local branch
git branch --track exercise2 origin/exercise2   # create local copy of "exercise2"
git checkout exercise2           # change to the "exercise2" branch
# start working...
</pre></div>
<p>Note that <code>git pull</code> is the combination of <code>git fetch</code> and <code>git merge</code>.</p>
</div>
<div class="slide">
<h1>Add New Functionality (step 4)</h1>
<p>Run jetty in <code>sbt</code> (i.e., <code>jetty-run</code>) and go to the web page. The <code>bogus</code> button is gone and there is now a <code>List Stocks</code> button. If you click it, you&#8217;ll get the same sort of error message that <code>bogus</code> triggered. Your mission is to make this work.</p>
<p>The UI code is already prepared. You just need to modify the server code, starting with the <span class="caps">REST</span> interface.</p>
</div>
<div class="slide">
<h1>Add New Functionality (step 5)</h1>
<ul>
	<li>Edit <code>RestfulDataPublisher.scala</code>. We need to do a little <em>refactoring</em> first.</li>
	<li>Change <code>getStatsFromInstrumentAnalysisServerSupervisors</code> to take this argument: <code>message: InstrumentCalculationMessages</code>.</li>
	<li>Change <code>supervisor !! CalculateStatistics(allCriteria)</code> to <code>supervisor !! message</code>.</li>
	<li>Now this method is more general to meet our needs.<br />
 <br />
</div><br />
<div class="slide"></li>
</ul>
<h1>Add New Functionality (step 6)</h1>
<ul>
	<li>Also in <code>RestfulDataPublisher.scala</code>, in method <code>getAllDataFor</code>, change:</li>
</ul>
<div class="code-tiny">
<pre name="code" id="code" class="brush: scala,;">

val results = getStatsFromInstrumentAnalysisServerSupervisors(allCriteria)
</pre></div>
<p>to</p>
<div class="code-tiny">
<pre name="code" id="code" class="brush: scala,;">

val results = getStatsFromInstrumentAnalysisServerSupervisors(CalculateStatistics(allCriteria))
</pre></div>
<ul>
	<li>Run the tests; they should all pass!</li>
	<li>In what follows, use the sbt <code>~test</code> target to keep your tests passing as much as possible. There will be some intermediate steps when they won&#8217;t pass.</li>
</ul>
</div>
<div class="slide">
<h1>Add New Functionality (step 7)</h1>
<ul>
	<li>Edit <code>InstrumentAnalysisServer.scala</code>.</li>
	<li>Add this new object definition after the definition of <code>CalculateStatistics</code>:</li>
</ul>
<div class="code-small">
<pre name="code" id="code" class="brush: scala,;">

case class GetInstrumentList(range: scala.collection.immutable.NumericRange[Char]) extends InstrumentCalculationMessages
</pre></div>
<ul>
	<li>(You can import <code>NumericRange</code> if you don&#8217;t want to put this fully-qualified name in the declaration.)</li>
</ul>
</div>
<div class="slide">
<h1>Add New Functionality (step 8)</h1>
<ul>
	<li>Back in <code>RestfulDataPublisher.scala</code>, edit the <code>restRequest</code> method.</li>
	<li>Add a case statement for the string &#8220;list_stocks&#8221;. (Follow the example for &#8220;stats&#8221;).</li>
	<li>Have the case handler call a method similar to <code>getAllDataFor</code>. Call it <code>getAllInstruments</code>. Pass one argument; the <code>instruments</code> variable, of type <code>String</code>.</li>
</ul>
</div>
<div class="slide">
<h1>Add New Functionality (step 9)</h1>
<ul>
	<li>If you copied and pasted <code>getAllDataFor</code> ;), change the first several lines in the <code>try</code> block to the following lines:</li>
</ul>
<div class="code-tiny">
<pre name="code" id="code" class="brush: scala,;">

// Hack! Just grab the first and last letters in the "instruments" string
// and use them as the range, but handle the case of 0 or 1 characters.
val symbolRange = instruments.trim match {
  case "" =&gt; `A` to `Z`  // default
  case s  =&gt; s.length match {
    case 1 =&gt; `A` to s.charAt(0).toUpper  // 1 character; use as end
    case n =&gt; s.charAt(0).toUpper to s.charAt(n-1).toUpper
  }
}
val results = getStatsFromInstrumentAnalysisServerSupervisors(GetInstrumentList(symbolRange))
val result = compact(render(JSONMap.toJValue(Map("instrument-list" -&gt; results))))
</pre></div>

<ul>
	<li><strong>Warning:</strong> those backticks ` should be forward ticks &#8217; (formatting problem!).</li>
</ul>
</div>
<div class="slide">
<h1>Add New Functionality (step 9b)</h1>
<p>(Added after the original lecture&#8230;)</p>
<p>In the exception handling code for <code>getAllInstruments</code>, note that the calls to <code>makeErrorString</code> won&#8217;t work, because the arguments to <code>getAllInstruments</code> are different than the arguments to <code>getAllDataFor</code>.</p>
<ul>
	<li>Instead, call a new function named <code>makeAllInstrumentsErrorString</code>.</li>
	<li>Create the <code>makeAllInstrumentsErrorString</code> method, taking an appropriate argument list.</li>
</ul>
</div>
<div class="slide">
<h1>Add New Functionality (step 10)</h1>
<ul>
	<li>Edit <code>InstrumentAnalysisServerSupervisors.scala</code>.</li>
	<li>In the <code>defaultHandler</code>, add this case clause.</li>
</ul>
<div class="code-tiny">
<pre name="code" id="code" class="brush: scala,;">

case GetInstrumentList(range) =&gt; self.reply(getInstrumentList(range))
</pre></div>
</div>
<div class="slide">
<h1>Add New Functionality (step 11)</h1>
<ul>
	<li>Create the <code>getInstrumentList</code> method, which takes one argument: <code>range: scala.collection.immutable.NumericRange[Char]</code>. It should look similar to the <code>calculate</code> method. The main difference is the <code>for</code> &#8220;comprehension&#8221; (loop):</li>
</ul>
<div class="code-small">
<pre name="code" id="code" class="brush: scala,;">

{
  val futures = for {
    letter &lt;- range  // Recall that range is something like 'A' to 'D'
    oneLetterRange = letter to letter
    instrument = Instrument(letter.toString)
    calculator &lt;- getOrMakeInstrumentAnalysisServerFor(instrument, Price(Dollars))
  } yield (calculator !!! GetInstrumentList(oneLetterRange))
  Futures.awaitAll(futures.toList)
  futuresToJSON(futures.toList, "None!")
}
</pre></div>
</div>
<div class="slide">
<h1>Add New Functionality (step 12)</h1>
<ul>
	<li>Edit <code>InstrumentAnalysisServer.scala</code>.</li>
	<li>Add the same case clause to <code>defaultHandler</code> that you added in <code>InstrumentAnalysisServerSupervisors.scala</code>.</li>
	<li>However, change the call to a <code>getInstrumentList</code> method to be a call on the <code>helper</code> object in the file.</li>
	<li>Create this method in the helper class. It must take the same one-argument that <code>InstrumentAnalysisServerSupervisors.getInstrumentList</code> took.</li>
	<li>Copy the body of <code>fetchPrices</code> to <code>getInstrumentList</code>.</li>
	<li>Make this new method public, not <code>protected</code>! (In Scala, the default is public)</li>
</ul>
</div>
<div class="slide">
<h1>Add New Functionality (step 13)</h1>
<ul>
	<li>In <code>getInstrumentList</code>, change the argument to the <code>Get</code> object that&#8217;s sent to <code>dataStorageServer</code> to <code>Pair("instrument_list", range.toList.head.toString)</code>. (We&#8217;ll just assume here that there is only one character in the range; we&#8217;re using one instance of this class per letter.)</li>
	<li>Change the error message for the <code>None</code> case to something appropriate.</li>
	<li>Change the <code>Some</code> case to simply return the <code>result</code>.</li>
</ul>
</div>
<div class="slide">
<h1>Add New Functionality (step 14)</h1>
<ul>
	<li>Implement <code>formatInstrumentListResults(result, range)</code>. Follow the example of <code>formatPriceResults</code>.</li>
	<li>Instead of the <code>criteria</code> entry in the Map, return &#8220;range&#8221; as the key and <code>range.toString</code> as the value.</li>
	<li>Keep the <code>results</code> part as is.</li>
</ul>
</div>
<div class="slide">
<h1>Add New Functionality (step 15)</h1>
<ul>
	<li>Edit <code>DataStorageServer</code>.</li>
	<li>Rename <code>getData</code> to <code>getDataForRange</code></li>
	<li><em>Copy</em> the function signature for <code>getDataForRange</code> and create a new <code>getData</code> with it. Use the following body:</li>
</ul>
<div class="code-small">
<pre name="code" id="code" class="brush: scala,;">

(criteria \ "instrument_list") match {
	case JField(key, JString(value)) =&gt; getInstrumentList(value)
  case _ =&gt; getDataForRange(criteria)
} 
</pre></div>
</div>
<div class="slide">
<h1>Add New Functionality (step 16)</h1>
<ul>
	<li>Create method <code>getInstrumentList</code>.</li>
	<li>Here we will use a hack to reduce the amount of code we would have to write for the general case. We&#8217;ll only worry about getting the list from MongoDB, not all data stores. (How could you eliminate this hack with a more general solution??)</li>
</ul>
<div class="code-tiny">
<pre name="code" id="code" class="brush: scala,;">

protected[persistence] def getInstrumentList(prefix: String): JValue = dataStore match {
  case mongo: MongoDBDataStore =&gt; 
    val data = for {
      json &lt;- mongo.getInstrumentList(prefix)
    } yield json
    toJSON(data toList)
  case _ =&gt; throw new RuntimeException("Can't get the instrument list from datastore "+dataStore)
}
</pre></div>
</div>
<div class="slide">
<h1>Add New Functionality (step 17)</h1>
<ul>
	<li>Add these imports to <code>MongoDBDataStore</code>.</li>
</ul>
<div class="code-small">
<pre name="code" id="code" class="brush: scala,;">

import net.liftweb.json.JsonAST._
import net.liftweb.json.JsonDSL._
import org.joda.time.format._
</pre></div>
</div>
<div class="slide">
<h1>Add New Functionality (step 18)</h1>
<ul>
	<li>Create method <code>getInstrumentList</code> in <code>MongoDBDataStore</code>. Here it is:</li>
</ul>
<div class="code-tiny">
<pre name="code" id="code" class="brush: scala,;">

// Hack!
def getInstrumentList(prefix: String): Iterable[JSONRecord] = try {
  // TODO: We hard-code the name of the thing we want, the "stock_symbol". Should be abstracted...
  val list = collection.distinct("stock_symbol")
  val buff = new scala.collection.mutable.ArrayBuffer[String]()
  val iter = list.iterator
  while (iter.hasNext) {
    buff += iter.next
  }
  // Must put in a timestamp to make JSONRecord happy:
  val format = DateTimeFormat.forPattern("yyyy-MM-dd")
  List(JSONRecord(("date" -&gt; format.print(new DateTime)) ~ ("letter" -&gt; prefix) ~ ("symbols" -&gt; buff.toList)))
} catch {
  case th =&gt; 
    log.error("MongoDB Exception: ", th)
    throw th
}
</pre></div>
</div>
<div class="slide">
<h1>Add New Functionality (step 19)</h1>
<p>Try it out! use <code>jetty-run</code> in <code>sbt</code>, enter two letters for the <code>Symbols</code> in the UI and click <code>List Stocks</code>. You should get a table with one row for all the symbols that start with the letter <code>A</code>, one row for <code>B</code>, etc.</p>
<p><strong>Warning:</strong> If might run out of memory if you ask for <code>A-Z</code> symbols! Try small ranges first.</p>
<p>Make sure the price queries still work.</p>
</div>
<div class="slide">
<h1>Add New Functionality (step 20)</h1>
<p>We did all these changes without adding tests for them. That&#8217;s not really the best way to work (as we&#8217;ll see later in the course). Go back through the changes and create tests for as many of them as you can. Where we copied existing code, find tests for the original code and see if you can copy and adapt those tests.</p>
</div>
<div class="slide">
<h1>Add New Functionality (final)</h1>
<p>Please commit your changes to GitHub by the start of class next week.</p>
</div>
<div class="title slide">
<h1>Lecture 4: Scaling Data, Part I</h1>
<p>For decades, Relational Databases have been the dominate tool for data persistence. There are other models that are also decades old.</p>
<p>You can find a short summary of many of them <a href="http://www.unixspace.com/context/databases.html">here</a>. We&#8217;ll discuss a few of them now.</p>
</div>
<div class="slide">
<h1>Hierarchical and Network Model</h1>
<ul>
	<li>Hierarchical:
	<ul>
		<li>Tree-based, parent-child relationships.</li>
		<li>1:N (one parent, N children).</li>
		<li>Popular in the late 1960&#8217;s through the 1970&#8217;s.</li>
	</ul></li>
	<li>Network:
	<ul>
		<li>M:N (many to many).</li>
		<li>Formally defined in 1971 at the Conference on Data Systems Languages (<span class="caps">CODASYL</span>).</li>
		<li>Based on set theory.</li>
		<li>Can have cycles in the network.</li>
	</ul></li>
</ul>
</div>
<div class="slide">
<h1>Relational Model</h1>
<ul>
	<li><span class="caps">RDBMS</span> &#8211; Relational Database Management System.</li>
	<li>Devised by Edgar F. Codd at <span class="caps">IBM</span> in 1970.</li>
	<li>A <strong>relation</strong>: a set of tuples (i.e., rows a table) that have the same &#8220;attributes&#8221; (i.e., columns).</li>
	<li>Rows are unique.</li>
	<li>Columns have types and unique names.</li>
	<li>Each row has the same set of columns.</li>
	<li>The sequence of rows and columns are not significant.</li>
	<li>1 or more columns may be indexed to speed up queries.</li>
</ul>
</div>
<div class="slide">
<h1>Object-Oriented Model</h1>
<ul>
	<li>Attempts to unify the programming and persistence models for languages like C++, Java, Smalltalk, etc.</li>
	<li>Supports inheritance.</li>
	<li>Eliminates the <em>impedence mismatch</em> required to persist objects to relational tables (inheritance is particularly tricky).</li>
	<li>Emerged in the 90&#8217;s.</li>
</ul>
</div>
<div class="slide">
<h1>Object-Oriented Model (cont.)</h1>
<ul>
	<li>Never really displaced <span class="caps">RDBMS</span>, even though most IT development is done using OO languages!
	<ul>
		<li>Performance was a serious problem in early OODBMSs.</li>
		<li>Database architects and developers tend to be conservative.</li>
		<li>Using <span class="caps">RDBMS</span> continued to be &#8220;good enough&#8221;.</li>
	</ul></li>
</ul>
</div>
<div class="slide">
<h1>Object/Relational Model</h1>
<ul>
	<li>Adds to the relational model the ability to define new types and specify the unique operations on those types.</li>
	<li>Examples include geospatial data, time-series data (e.g., stock prices), and binary media like images, audio, and video.</li>
	<li>Doesn&#8217;t support inheritance in the usual <span class="caps">OOP</span> sense.</li>
	<li>Most of the big <span class="caps">RDBMS</span> vendors offer some O/R capabilities.</li>
	<li>Compromise solution that also emerged in the 90&#8217;s.</li>
</ul>
</div>
<div class="slide">
<h1>Requirements for Data Persistence</h1>
<ul>
	<li><span class="caps">ACID</span>
	<ul>
		<li><strong>A</strong>: Atomicity</li>
		<li><strong>C</strong>: Consistency</li>
		<li><strong>I</strong>: Isolation</li>
		<li><strong>D</strong>: Durability</li>
	</ul></li>
</ul>
<p>When we discussed <span class="caps">ACID</span> two weeks ago, we mostly talked about <span class="caps">ACI</span> in the context of <em>software transactional memory</em>. Let&#8217;s talk a bit more about durability.</p>
</div>
<div class="slide">
<h1>Durability</h1>
<p><em>Committed transactions are permanent.</em></p>
<p>&#8230;meaning they will survive system failure.</p>
<p>Often implemented with a transaction log that can be &#8220;replayed&#8221; if recovery is required.</p>
<p>But what if the log was on the system that failed? What if we can&#8217;t wait for the time it takes to replay the log (after we fix the broken system)?</p>
</div>
<div class="slide">
<h1>Requirements for &#8220;Web Scale&#8221; Data Persistence</h1>
<ul>
	<li><strong>High Availability:</strong> If there&#8217;s one server, we can&#8217;t tolerate it crashing.</li>
	<li><strong>Horizontal Scaling:</strong> No one server can &#8220;implement&#8221; Google.</li>
	<li><strong>Flexibility, Extensibility:</strong> So we can grow our business with minimal cost.</li>
</ul>
</div>
<div class="slide">
<h1>Some Techniques We&#8217;ll Discuss</h1>
<ul>
	<li>Replication</li>
	<li>Schema-less Design</li>
	<li>MapReduce</li>
</ul>
</div>
<div class="slide">
<h1>Some Techniques We&#8217;ll Discuss</h1>
<ul>
	<li><strong>Replication</strong></li>
	<li>Schema-less Design</li>
	<li>MapReduce</li>
</ul>
</div>
<div class="slide">
<h1>Replication and Sharding</h1>
<p><strong>Replication:</strong> Duplicate copies of the same data.</p>
<ul>
	<li>Replication Enables Failover</li>
	<li>If you have duplicate data and duplicate software, then if one system goes down, the other(s) can take over the load.</li>
	<li>Three of the possible configurations:
	<ul>
		<li><strong>Master-Slave:</strong> One dominate server; if it fails, the slave takes over.</li>
		<li><strong>Mated Pair:</strong> Computation distributed between pairs. If one fails, the other takes the full load.</li>
		<li><strong>N Peers:</strong> Scaled up version of <em>mated pair</em> to N servers.</li>
	</ul></li>
</ul>
</div>
<div class="slide">
<h1>Replication and Sharding</h1>
<p><strong>Sharding:</strong> Splitting a large data set across multiple servers.</p>
<ul>
	<li>Customer orders on the East coast are stored in New Jersey.</li>
	<li>Customer orders on the West coast are stored in Oregon.</li>
	<li>&#8230;<br />
or split <em>functionality</em> across servers:</li>
	<li>Customer orders on one server.</li>
	<li>Inventory on another server.</li>
	<li>&#8230;</li>
</ul>
</div>
<div class="slide">
<h1>Sharding with Replication</h1>
<p>Get horizontal scalability and replication by combining both sharding with replication. Here&#8217;s an example using MongoDB.</p>
<p><img src="images/mongodb_sharding_replica_sets.png"><img></div>
<div class="slide">
<h1>Distributed Data and Latency</h1>
<p>When you scale by sharding (or <em>partitioning</em>) your data. You would like to maintain <span class="caps">ACID</span> compliant transactions across the data shards. The traditional approach is to rely upon distributed transactions and two-phase commit.</p>
</div>
<div class="slide">
<h1>Distributed Transactions &amp; Two-Phase Commit</h1>
<ul>
	<li><strong>Distributed Transactions:</strong> Join transactions on individual systems into a larger transaction that spans the systems.</li>
	<li><strong>Two-Phase Commit:</strong> A <em>consensus</em> protocol for whether to complete or abort the distributed transaction:<br />
1. <em>Commit Request Phase:</em> Ask all participants to prepare to commit and <em>vote</em> whether or not to proceed.<br />
2. <em>Commit Phase:</em> Complete the commit <em>if all</em> participants vote yes, otherwise abort.</li>
</ul>
</div>
<div class="slide">
<h1>What Happens at Enormous Scales?</h1>
<p>Imagine you&#8217;re Amazon. You have thousands (millions?) of customers shopping at your site every day. You are saving information about searches, products viewed, products put in wish lists, orders placed, credit cards charged, etc.</p>
<p>Massive sharding and replication don&#8217;t eliminate new phenomena that happen at large scales&#8230;</p>
</div>
<div class="slide">
<h1><span class="caps">CAP</span></h1>
<p>Eric Brewer (Professor at the University of California, Berkeley and the cofounder and chief scientist at Inktomi) conjectured in 2000 that you can&#8217;t satisfy all three of the following properties at once in World-scale systems.</p>
<ul>
	<li><strong>C</strong> &#8211; Consistency: To a client, an operation occurs all at once (Note: this is really <em>Atomicity</em> in <span class="caps">ACID</span>).</li>
	<li><strong>A</strong> &#8211; Availability: Every operation completes to an expected result.</li>
	<li><strong>P</strong> &#8211; Partition Tolerance: Operations will complete, even if some system components are unavailable (&#8220;partitioned&#8221; from the others).</li>
</ul>
</div>
<div class="slide">
<h1><span class="caps">CAP</span> (cont.)</h1>
<p>In <a href="http://nosqlsummer.org/paper/cap-theorem">The <span class="caps">CAP</span> Theorem</a>, Seth Gilbert and Nancy Lynch elaborate on <span class="caps">CAP</span>, providing a proof of it, and offering real-world solutions.</p>
<p>They point out:</p>
<ul>
	<li>Consistency: Distributed operations in a transaction appear as if they are on one node.</li>
	<li>Availability: A weak form of availability is implied; there is no explicit limit on how long a transaction will take to complete and return a result!</li>
	<li>Partition Tolerance: No set of failures less than total network failure is allowed to cause the system to respond incorrectly.</li>
</ul>
</div>
<div class="slide">
<h1><span class="caps">CAP</span>: Pick Two</h1>
<p>Brewer observed that you can pick two of the three: CA, AP, or CP.</p>
<p>(Section 3.2 of Gilbert and Lynch discuss these combinations.)</p>
</div>
<div class="slide">
<h1>Consistency (Atomicity) and Availability</h1>
<p>&#8230; but not Partition Tolerance.</p>
<p>E.g., distributed systems in a &#8220;reliable&#8221; <span class="caps">LAN</span>.</p>
<ul>
	<li>Atomicity is provided by distributed transactions and 2-phase commit.</li>
	<li>Availability is ensured by system reliability.</li>
	<li>But if a partition forms (e.g., a node goes down), atomicity and availability are not guaranteed.
	<ul>
		<li>I.e., these systems are usually designed with the assumption of no partitions and guaranteed atomicity, so they will appear unavailable when a partition forms.</li>
	</ul></li>
</ul>
</div>
<div class="slide">
<h1>Availability and Partition Tolerance</h1>
<p>&#8230; but not Consistency (Atomicity)</p>
<p>E.g., Google, Amazon, &#8230;</p>
<ul>
	<li>Systems remain available, even when someone cuts a trans-ocean data cable&#8230;</li>
	<li>However, the data seen on either side of the cut might be different.</li>
	<li>Data caches can exhibit this property. You&#8217;re local cache of search results might be slightly stale, but returning a result quickly is more important than taking longer to return a more accurate result.</li>
</ul>
</div>
<div class="slide">
<h1>Consistency (Atomicity) and Partition Tolerance</h1>
<p>&#8230; but not Availability. Useful when it&#8217;s better to never allow stale data, even if it means that no service is available at all.</p>
<p>E.g., a distributed <span class="caps">DBMS</span> in a <span class="caps">LAN</span>, using distributed locking.</p>
<ul>
	<li>There are rarely partitions, so it&#8217;s usually &#8220;tolerant&#8221;.</li>
	<li>Atomicity is provided by the <span class="caps">DBMS</span> and distributed transaction framework.</li>
	<li>But if a partition occurs (e.g., node crash), it might become unavailability, but it never returns inconsistent data.</li>
</ul>
</div>
<div class="slide">
<h1>Distributed Data and Latency</h1>
<p>Users expect fast responses (low latency), but the speed of light can&#8217;t be increased. (It takes about 19ms for light to travel from New York to London) Also, to be globally available requires distribution of services for fault tolerance.</p>
</div>
<div class="slide">
<h1>Distributed Data and Latency (cont.)</h1>
<p>To meet these goals, your architecture has to tolerate high latency (<a href="http://www.infoq.com/articles/pritchett-latency">Dan Pritchett</a>). A couple of techniques help.</p>
<ul>
	<li>Moving data and computing resources close to customers.
	<ul>
		<li>Lowers the round-trip time</li>
	</ul></li>
	<li>Doing as much calculation asynchronously as possible.
	<ul>
		<li>E.g., google indexes the web asynchronously, so searches use precomputed data and are &#8220;instantaneous&#8221;.</li>
	</ul></li>
</ul>
<p><img src="images/google-search.png"><img></p>
</div>
<div class="slide">
<h1>Distributed Data and Latency (cont.)</h1>
<p>Suppose you scale by partitioning your data. You would like to maintain <span class="caps">ACID</span> compliant transactions across the data partitions. The traditional approach is to rely upon distributed transactions and two-phase commit.</p>
</div>
<div class="slide">
<h1>The Problem with Distributed Transactions</h1>
<p>But distributed transactions create <em>synchronous</em> couplings across the databases, which can increase latency substantially</p>
<p>When partitions are present, the transaction may never complete successfully!</p>
</div>
<div class="slide">
<h1>The alternative to <span class="caps">ACID</span> is <span class="caps">BASE</span>:</h1>
<ul>
	<li><b>B</b>asically <b>A</b>vailable</li>
	<li><b>S</b>oft state</li>
	<li><b>E</b>ventually consistent</li>
</ul>
<p>(A contrived acronym, like <span class="caps">ACID</span>.)</p>
<p>When availability is the top priority, then try to always provide some level of service, don&#8217;t insist on absolutely consistent state (i.e., tolerate some stale data), and expect the system to become consistent, <em>eventually</em>.</p>
<p>There&#8217;s a spectrum between <span class="caps">ACID</span> and <span class="caps">BASE</span> for <em>each part</em> of the system.</p>
</div>
<div class="slide">
<h1><span class="caps">ACID</span> vs <span class="caps">BASE</span></h1>
<p>To be clear, <span class="caps">BASE</span> is a <strong>compromise</strong>.</p>
<p>Everyone would prefer to always have <span class="caps">ACID</span> compliance, but they are willing to accept <span class="caps">BASE</span> when <span class="caps">ACID</span> can&#8217;t be met.</p>
</div>
<div class="slide">
<h1>Some Techniques We&#8217;ll Discuss</h1>
<ul>
	<li>Replication</li>
	<li><strong>Schema-less Design</strong></li>
	<li>MapReduce</li>
</ul>
</div>
<div class="slide">
<h1>Do We Need an <span class="caps">RDBMS</span>?</h1>
<p>The issues of scaling, <span class="caps">CAP</span> and <span class="caps">BASE</span> vs. <span class="caps">ACID</span> that we have just discussed apply equally to traditional <span class="caps">RDBMS</span>, as well as to newer persistence technologies.</p>
</div>
<div class="slide">
<h1>Do We Need an <span class="caps">RDBMS</span>?</h1>
<ul>
	<li>Amazon, Google, eBay, Yahoo!, and other large-scale Internet companies have found that the cost of scaling traditional <span class="caps">RDBMS</span> is high and not always &#8220;worth it&#8221;.</li>
	<li>Social networking sites like Twitter and Facebook have enormous <em>graphs</em> of social relationships to manage.</li>
	<li>If data is easily sharded, because the shards have no references spanning them, then is the relational model essential?</li>
	<li>If <span class="caps">ACID</span> isn&#8217;t essential for all operations, are there lighter-weight persistence alternatives?</li>
</ul>
</div>
<div class="slide">
<h1>&#8220;NoSQL&#8221;</h1>
<p><em>Not <span class="caps">SQL</span></em> or <em>Not Only <span class="caps">SQL</span></em></p>
<ul>
	<li>If you have a graph of data, use a <em>graph</em> database.</li>
	<li>If you need great flexibility in the data format, use an &#8220;informal&#8221;, easily-changed schema, use a <em>document-oriented</em> or <em>column oriented</em> database.</li>
	<li>If an eventually-consistent, highly-scalable database is needed, consider &#8230; several options</li>
</ul>
</div>
<div class="slide">
<h1>Categories of &#8220;NoSQL&#8221; Databases</h1>
<ul>
	<li>Column Oriented (vs. the row orientation of <span class="caps">RDBMS</span>)</li>
	<li>Document Oriented</li>
	<li>Key-Value/Tuple Stores</li>
	<li>Eventually Consistent Key-Value Stores</li>
	<li>Graph Databases</li>
	<li>Grid Databases</li>
</ul>
<p>(Compare with <a href="http://nosql-database.org/">NoSQL-Database.org</a>)</p>
</div>
<div class="slide">
<h1>Column Oriented</h1>
<p>E.g., <em>Cassandra, Hadoop/HBase, Hypertable</em></p>
<p><strong>Column-oriented</strong> storage is often better for <span class="caps">OLAP</span> (OnLine Analytical Processing), e.g., Data analytics using Data Warehouses.</p>
<p><strong>Row-oriented</strong> storage if often better for <span class="caps">OLTP</span> (OnLine Transaction Processing), e.g., typical &#8220;live&#8221; transactions.</p>
</div>
<div class="slide">
<h1>Column Oriented (cont.)</h1>
<p><strong>Column-oriented</strong> storage is often better for&#8230;</p>
<ul>
	<li>optimizing space (compression) for very different-sized values in the same column (e.g., binary data).</li>
	<li>optimizing disk access for small subsets of all columns.</li>
	<li>Adding and removing columns frequently.</li>
</ul>
<p>Many of the largest NoSQL database instances are column databases.</p>
</div>
<div class="slide">
<h1>Document Oriented</h1>
<p>E.g., <em>MongoDB, CouchDB, Terrastore</em></p>
<p>Stores <em>documents</em>, usually in the form of <span class="caps">JSON</span> (JavaScript Object Notation), <span class="caps">YAML</span> (Yet Another Markup Language), or <span class="caps">XML</span> (eXtensible Markup Language).</p>
<ul>
	<li><strong>Schemaless:</strong> No fixed schema, <em>semistructured</em> data.
	<ul>
		<li>Contrast with <span class="caps">RDBMS</span>.</li>
		<li>But the document must be &#8220;well formed&#8221; (valid <span class="caps">JSON</span>, <span class="caps">YAML</span>, or <span class="caps">XML</span>).</li>
	</ul></li>
	<li>Often lightweight, so performance is often very good.
	<ul>
		<li>(We&#8217;ll explore this topic more next week.)</li>
	</ul></li>
</ul>
</div>
<div class="slide">
<h1>Document Oriented (cont.)</h1>
<ul>
	<li>Often support a query capability or language (even tough they&#8217;re <em>schemaless</em>).</li>
	<li>Often support a <em>MapReduce</em> capability.</li>
	<li>Excellent for medium-sized datasets with rapidly-evolving &#8220;schema&#8221;.</li>
</ul>
</div>
<div class="slide">
<h1>Digression: Why the Term &#8220;Document&#8221;?</h1>
<ul>
	<li><span class="caps">XML</span> (and <span class="caps">HTML</span>) are simplified derivatives of <span class="caps">SGML</span> (Standard Generalized Markup Language).
	<ul>
		<li>Long-time standard in the publishing industry.</li>
		<li><strong>Markup</strong> is the term for editing and arranging content for publication.</li>
	</ul></li>
</ul>
<p>Hence, we store <span class="caps">JSON</span> <em>documents</em> in MongoDB and CouchDB, etc.</p>
<p>Similarly, we store <span class="caps">YAML</span> or <span class="caps">XML</span> in documents tailored to them.</p>
</div>
<div class="slide">
<h1>Key-Value Stores</h1>
<p>E.g., <em>Amazon SimpleDB, Riak, Redis, Tokyo Cabinet, Scalaris, MemcacheDB, BerkeleyDB, MNesia.</em><br />
 <br />
Think of hash maps on <em>steroids</em>.</p>
<ul>
	<li>May be purely in-memory (with optional flushing to disk) and resident on one machine.</li>
	<li>Excellent for &#8220;persisting&#8221; semi-structured data with shorter lifespans (e.g., web sessions).</li>
	<li>Used when durability and consistency are lower priorities compared to speed.</li>
</ul>
</div>
<div class="slide">
<h1>Eventually Consistent Key-Value Stores</h1>
<p>E.g., <em>Amazon Dynamo, Dynomite, Voldemort</em></p>
<p>More emphasis on longer-lived objects that need to be persisted, but for which rapid retrieval is still important.</p>
<ul>
	<li>Transparent replication of data.</li>
	<li>Transparent clustering of nodes.</li>
	<li>Great for fault tolerance, especially for &#8220;active sessions&#8221;.</li>
</ul>
</div>
<div class="slide">
<h1>Graph Databases</h1>
<p>E.g., <em>Neo4J, Flock</em></p>
<p>Built in semantics for representing graphs, including cycles.</p>
<ul>
	<li>First-class support for nodes, edges, and properties to associate information with nodes and edges.</li>
	<li>Good when lots of expensive joins would be required in a <span class="caps">RDBMS</span>.</li>
	<li>Handle evolving schema easily.</li>
</ul>
</div>
<div class="slide">
<h1>Grid Databases</h1>
<p>E.g., <em>GridGain, HazelCast, Coherence</em></p>
<p>Less like a database in the usual sense and more of a virtualized space where data is transparently resident on more than one server/service.</p>
</div>
<div class="slide">
<h1>&#8220;Polyglot Persistence&#8221;</h1>
<p>A big trend today is that non-trivial systems mix different programming languages, libraries and tools. Do we use just one language to write all parts of a standard web application? No. <sup>1</sup></p>
<p>The same phenomenon is now happening at the persistence level. Often, one persistence strategy doesn&#8217;t fit all needs in complex, distributed systems. You might use a fast, key-value store for user sessions, then persist key &#8220;events&#8221; to an <span class="caps">RDBMS</span>, for example.</p>
<p><sup class="footnote"><a href="#fn1">1</a></sup> Well, maybe we could with JavaScript&#8230;</p>
</div>
<div class="slide">
<h1>Some Techniques We&#8217;ll Discuss</h1>
<ul>
	<li>Replication</li>
	<li>Schema-less Design</li>
	<li><strong>MapReduce</strong></li>
</ul>
<p>We&#8217;ll discuss MapReduce in a few weeks&#8230;</p>
</div>
<div class="slide">
<h1>Reading Assignment: <span class="caps">CAP</span> and <span class="caps">BASE</span></h1>
<ul>
	<li>Julian Brown, <a href="http://www.julianbrowne.com/article/viewer/brewers-cap-theorem">Brewer&#8217;s <span class="caps">CAP</span> Theorem: The Kool Aid Amazon and eBay Have Been Drinking</a>. Sometimes amusing discussion of Brewer&#8217;s theorem. (We&#8217;ll read Brewer&#8217;s original presentation &#8211; a conference keynote &#8211; in a later assignment.)</li>
	<li>Dan Pritchett, <a href="http://queue.acm.org/detail.cfm?id=1394128"><span class="caps">BASE</span>: An Acid Alternative</a>. Excellent discussion of the limitations of <span class="caps">ACID</span> for large-scale, distributed systems, and the alternative, <span class="caps">BASE</span>. Provides specific examples of techniques for relaxing consistency.</li>
</ul>
</div>
<div class="slide">
<h1>Reading Assignment:</h1>
<p>Read the discussion on MongoDB <em>Replication</em> and <em>Sharding</em> (links on subsequent slides). MongoDB&#8217;s implementations are representative examples of these general techniques and the reading will also help you get more familiar with MongoDB, which we&#8217;ll discuss in depth next week.</p>
<p>Focus instead on the concepts discussed. The particular syntax details of MongoDB commands and the details of which techniques to use with particular versions of MongoDB, etc. aren&#8217;t important.</p>
</div>
<div class="slide">
<h1>Reading Assignment: Replication</h1>
<p><a href="http://www.mongodb.org/display/DOCS/Replication">mongodb.org/display/<span class="caps">DOCS</span>/Replication</a></p>
<p>Follow the link in the section <em>Verifying propagation of writes with getlasterror</em>.  What&#8217;s important here is why this is an issue &#8211; why would a client care if propagation happens immediately or not?</p>
<p>View the video or read the slides describing MongoDB&#8217;s new approach to replication, called <em>replica sets</em>.</p>
<ul>
	<li><a href="http://lacantine.ubicast.eu/videos/21-06-2010-130932-partie-6/">Video</a></li>
	<li><a href="http://www.slideshare.net/mongodb/mongodb-replica-sets">Slides</a></li>
</ul>
<p>(Yes, it appears that something is wrong with the last 5 or so slides, but the &#8220;good&#8221; slides have the content I care about&#8230;)</p>
</div>
<div class="slide">
<h1>Reading Assignment: Sharding</h1>
<p><a href="http://www.mongodb.org/display/DOCS/Sharding+Introduction">mongodb.org/display/<span class="caps">DOCS</span>/Sharding+Introduction</a></p>
<p>Make sure you understand the different goals of replication and sharding and how they also complement each other. Also, when combined, as discussed on the Sharding page, are there any <em>single points of failure</em>?</p>
</div>
<div class="slide">
<h1>Exercise</h1>
<p>Complete exercise2, which was assigned last week. It is due by the start of the next class, September 28.</p>
</div>
<div class="title slide">
<h1>Lecture 5: Scaling Data, Part II</h1>
<p>Today and next week we&#8217;ll discuss some NoSQL databases in depth.</p>
</div>
<div class="slide">
<h1>MongoDB and CouchDB</h1>
<ul>
	<li>MongoDB: <a href="http://mongodb.org">mongodb.org</a></li>
	<li>CouchDB: <a href="http://couchdb.apache.org">couchdb.apache.org</a></li>
</ul>
<p>Both are document oriented, use <span class="caps">JSON</span>, are schemaless, and support JavaScript for programming many database operations. But they are very different in other ways, a reflection of their different goals.</p>
</div>
<div class="slide">
<h1>CouchDB Architecture</h1>
<p>Internal architecture.</p>
<p><img src="images/CouchDB-architecture-sketch.png"><img><br />
<br />
(source: <a href="http://couchdb.apache.org/">couchdb.apache.org</a>)</div>
<div class="slide">
<h1>MongoDB Architecture</h1>
<p>Simpler internal architecture. Lots of small services, as shown here:</p>
<p><img src="images/mongodb_sharding_replica_sets.png"><img><br />
<br />
(source: <a href="http://mongodb.org/">mongodb.org</a>)</div>
<div class="slide">
<h1>Differences Between MongoDB and CouchDB</h1>
<ul>
	<li>Persistence Strategy</li>
	<li>Scalability</li>
	<li>Queries</li>
	<li>MapReduce</li>
	<li>Transactions</li>
	<li>&#8220;Driver&#8221; APIs</li>
	<li>Ideal Applications</li>
</ul>
<p>(Some of these points adapted from <a href="http://www.mongodb.org/display/DOCS/Comparing+Mongo+DB+and+Couch+DB">Comparing Mongo DB and Couch DB</a>)</p>
</div>
<div class="slide">
<h1>Persistence Strategy</h1>
<p><em>CouchDB uses <strong><span class="caps">MVCC</span></strong>, while MongoDB uses <strong>update in place</strong>.</em></p>
<p>Recall that <span class="caps">MVCC</span> is <em>multiversion concurrency control</em>. We discussed it when talking about <em>software transactional memory</em> (<span class="caps">STM</span>). In <span class="caps">MVCC</span> a new version of the document is created with the desired changes. The previous versions are still available, until they are specifically deleted (or <em>compacted</em> into fewer versions).</p>
<p>Update in place just means that we insert changes directly into the existing document&#8217;s record, so previous values are overwritten.</p>
</div>
<div class="slide">
<h1>Advantages of <span class="caps">MVCC</span></h1>
<p>Better for <strong>durability</strong>. <em>Append-only log files</em> are a database industry standard for durable transactions. CouchDB uses an append-only BTree on disk, so updates are durable (if the files survive&#8230;). If CouchDB crashes, you just restart and go. (BTrees are N-ary sorted trees that are optimal for relatively slow read operations, like disk and file access.)</p>
<p>If conflicting updates happen, <em>both</em> of them are saved.</p>
<p><span class="caps">MVCC</span> is very good for syncing master-master database configurations. For example, you can create a copy of the database, take it offline and work on it, then sync it to the other copies when back online again. CouchDB has bi-directional replication.</p>
<p><strong>Note:</strong> distributed version control systems like <em>git</em> work the same way.</p>
</div>
<div class="slide">
<h1>Disadvantages of <span class="caps">MVCC</span></h1>
<p>Making copies of documents is slower, consumes more space over time. Compaction is required occasionally.</p>
<p>Update conflicts must be resolved manually (although now update is &#8220;lost&#8221; and CouchDB deterministically picks a default &#8220;winner&#8221;).</p>
</div>
<div class="slide">
<h1>Advantages of Update in Place</h1>
<p>Faster write performance, especially for updates. Since the document isn&#8217;t copied, updates are faster. However, this statement ignores disk seek time for finding those records. An append-only file on a disk with no other read/write operations will have minimal seek time, thereby boosting performance. (This is  a case where real-world performance will have to be determined by measurement.)</p>
<p>Compaction isn&#8217;t needed to remove unneeded copies of documents, since multiple versions aren&#8217;t created.</p>
<p>Better for Master-Slave configurations with failover.</p>
</div>
<div class="slide">
<h1>Disadvantages of Update in Place</h1>
<p>If conflicting updates occur, only the last one survives. Transactions are more important to avoid collisions with out the recovery option that <span class="caps">MVCC</span> provides (e.g., picking a previous version or merging results some how).</p>
<p>If MongoDB crashes, you will probably need to repair the database, prolonging the recovery and restoration of normal service. This is one reason why MongoDB recommends replicated database instances, so service is not interrupted. However, once the crashed instances are running again, you&#8217;ll need to resync them, to get the most recent transactions pushed to the newly-recovered instance.</p>
</div>
<div class="slide">
<h1>Disadvantages of Update in Place (cont.)</h1>
<p><em>CouchDB is much more durable for single database instances, but most production systems should have replication anyway.</em></p>
</div>
<div class="slide">
<h1>Other Notes on Durability</h1>
<p>To maximize write performance, MongoDB uses memory-mapped files that are persisted to disk every 60 seconds, by default (using <em>fsync</em>). This also means that concurrent reads can see stale data, even after an <span class="caps">API</span> call for writing returns. Synchronous disk writes are possible, but they impede performance.</p>
<p>CouchDB can also do &#8220;delayed commits&#8221;, i.e., write operations return immediately, but the actual fsync occurs every second, by default. However, they recommend not doing delayed commits, trading some some performance for better durability.</p>
<p>(see also <a href="http://www.mikealrogers.com/2010/07/mongodb-performance-durability/">MongoDB Performance and Durability</a>)</p>
</div>
<div class="slide">
<h1>Other Notes on Durability (cont.)</h1>
<p><strong>Note:</strong> High end servers often have battery-backed <span class="caps">RAID</span> controllers, where the fsync appears to complete faster, but the <span class="caps">RAID</span> delays commits (often using sophisticated algorithms to sequence reads and writes in order to minimize disk head seeks). You get the best of both worlds, fast fsync plus durability ensured by battery backup.</p>
<p><strong>Moral:</strong> You have to understand your full system and measure what you want to optimize.</p>
</div>
<div class="slide">
<h1>Scalability</h1>
<p>CouchDB uses replication to scale, where different instances can work on different parts of the data. However, that approach is limited when the database becomes huge. There are some third party sharding/partitioning approaches, the leader of which is <a href="http://github.com/cloudant/bigcouch">BigCouch</a>, which provides transparent clustering, fault-tolerance, and high availability. (Cloudant provides professional services for CouchDB installations.)</p>
<p>MongoDB uses replication for durability and availability and sharding for scalability. (Discussed in last week&#8217;s reading assignment.)</p>
</div>
<div class="slide">
<h1>Durability, Replication, and Consistency</h1>
<p>When replicating CouchDB instances, you get <em>eventual consistency</em>. Note that if one replica is offline, consistency can&#8217;t happen until it comes online again.</p>
<p>Some NoSQL systems, like Cassandra, let you define that a write operation is complete when M of N replicas have received the write.</p>
</div>
<div class="slide">
<h1>Queries</h1>
<p>MongoDB provides a full-featured, <em>ad hoc</em> query capability using JavaScript as the query language. You can do almost any kind of query that you can do with <span class="caps">SQL</span> in a <span class="caps">SQL</span> database. For some cases, the built-in MapReduce framework has to be used. (We&#8217;ll cover that in a few weeks.)</p>
<p>CouchDB does not provide an <em>ad hoc</em> query mechanism. Instead, it emphasizes creating views onto the data. You design your database with specific indexing and MapReduce operations that execute incremental when updates are made. These views efficiently expose the data you want, formatted the way you want it.</p>
</div>
<div class="slide">
<h1>MapReduce</h1>
<p>Both systems support <em>MapReduce</em>. CouchDB requires writing MapReduce functions to construct the views. MongoDB provides MapReduce for optimizing some computations, but the query language doesn&#8217;t require MapReduce functions.</p>
</div>
<div class="slide">
<h1>Transactions</h1>
<p>Neither database supports the full transaction capabilities typically found in RDBMSs. They do this to keep the systems lighter and faster.</p>
<p>Instead, MongoDB offers several <a href="http://www.mongodb.org/display/DOCS/Atomic+Operations">atomic operations</a> for <em>single</em> documents (i.e., rows, in <span class="caps">RDBMS</span> terminology).</p>
<p>Similarly, CouchDB also supports document-level transactions through <span class="caps">MVCC</span>, providing optimistic updates, but records when a collision occurs, recording <em>both</em> updates, and using a deterministic algorithm to pick the &#8220;winner&#8221;. Normally, though, the application should decide how to resolve the collision.</p>
</div>
<div class="slide">
<h1>&#8220;Driver&#8221; APIs: CouchDB</h1>
<p>While there are language drivers for CouchDB, the primary way to interact with a CouchDB database is through a <span class="caps">REST</span> <span class="caps">API</span>. This is particularly useful for building two-tier applications, with a web (presentation) tier that communicates with the persistence tier over <span class="caps">REST</span>. All business logic is implemented as part of the database view design described above.</p>
<p>This model is very convenient for smaller applications. Larger applications typically use 3 or more tiers.</p>
</div>
<div class="slide">
<h1>&#8220;Driver&#8221; APIs: MongoDB</h1>
<p>For performance reasons, MongoDB is accessed primarily through language drivers for C++, Java, Ruby, etc. These drivers talk a proprietary binary protocol. There is also a limited <span class="caps">REST</span> <span class="caps">API</span> available. The driver approach is more traditional for n-tier applications, but it is less convenient for applications where web pages want to access a MongoDB database directly (over <span class="caps">HTTP</span>).</p>
</div>
<div class="slide">
<h1>Ideal Applications</h1>
<p>So, while superficially similar, they are very different in important ways, which affects the kinds of applications for which each is ideal.</p>
</div>
<div class="slide">
<h1>Ideal Applications: CouchDB</h1>
<p>CouchDB is ideal for:</p>
<ul>
	<li>Productivity applications with built in databases, where offline work is common, with subsequent synching to the &#8220;master&#8221;. Think email, calendaring, &#8220;<span class="caps">TODO</span>&#8221; and similar apps.</li>
	<li>Persistence with easy replication is more important that update throughput.</li>
	<li>Easy integration with web front ends, through <span class="caps">REST</span>.</li>
	<li>Many apps that Ruby on Rails is currently used to implement.</li>
</ul>
</div>
<div class="slide">
<h1>Ideal Applications: MongoDB</h1>
<p>MongoDB is ideal for:</p>
<ul>
	<li>Applications with high-volume writes/updates, especially if some write losses are tolerable (e.g., sensor networks).</li>
	<li>System &#8220;logs&#8221; (especially with <a href="http://www.mongodb.org/display/DOCS/Capped+Collections">capped collections</a>).</li>
	<li>Applications requiring ad hoc query support.</li>
	<li>Applications requiring fast language-specific drivers.</li>
</ul>
</div>
<div class="slide">
<h1>Conclusions: MongoDB vs. CouchDB</h1>
<p>MongoDB is philosophically more like a traditional <span class="caps">RDBMS</span>, and you use it in much the same way.</p>
<p>CouchDB is more like an application platform for two-tier applications that require persistence, with solid, easy replication.</p>
<p><em>JavaScript from the database to the browser is becoming a compelling application development approach.</em></p>
</div>
<div class="slide">
<h1>Key-Value Stores</h1>
<p>E.g., <em>Amazon SimpleDB, Riak, Redis, Tokyo Cabinet, Scalaris, MemcacheDB, BerkeleyDB, Mnesia.</em><br />
 <br />
Think of hash maps on <em>steroids</em>.</p>
<ul>
	<li>May be purely in-memory (with optional flushing to disk) and resident on one machine.</li>
	<li>Excellent for &#8220;persisting&#8221; semi-structured data with shorter lifespans (e.g., web sessions).</li>
	<li>Used when durability and consistency are lower priorities compared to speed.</li>
</ul>
</div>
<div class="slide">
<h1>Eventually Consistent Key-Value Stores</h1>
<p>E.g., <em>Amazon Dynamo, Dynomite, Voldemort</em></p>
<p>More emphasis on longer-lived objects that need to be persisted, but for which rapid retrieval is still important.</p>
<ul>
	<li>Transparent replication of data.</li>
	<li>Transparent clustering of nodes.</li>
	<li>Great for fault tolerance, especially for &#8220;active sessions&#8221;.</li>
</ul>
<p>Your homework reading will include a paper on Dynamo.</p>
</div>
<div class="slide">
<h1>Are Key-Value Stores Really Databases?</h1>
<p><a href="http://memcached.org/">Memcached</a> has been around a while. It&#8217;s a popular in-memory, distributed cache. It&#8217;s great for caching database queries in memory, for faster repeat retrieval, storing user sessions between page views in a web application, etc.</p>
<p>The definition of &#8220;database&#8221; has expanded in recent years, so now we think of a key-value store, like memcached, as a datastore, <em>if</em> it is backed by some sort of durability.</p>
<p><a href="http://memcachedb.org/">MemcacheDB</a> is built on top of Memcached to provide this durability. It uses another, fairly old, open-source NoSQL store, <a href="http://www.oracle.com/technetwork/database/berkeleydb/index.html">BerkeleyDB</a> to provide persistence.</p>
</div>
<div class="slide">
<h1>MemcacheDB</h1>
<p>It&#8217;s <span class="caps">API</span> is compliant with the Memcache protocol:</p>
<ul>
	<li>get(also multiple get)</li>
	<li>set, add, replace</li>
	<li>append/prepend</li>
	<li>incr, decr</li>
	<li>delete</li>
	<li>stats</li>
</ul>
<p>Very simple! If all you need is key-based storage and retrieval of &#8220;blobs&#8221;, then a key-value store like this can be ideal.</p>
</div>
<div class="slide">
<h1>Redis</h1>
<p><a href="http://code.google.com/p/redis/">Redis</a> provides data-structure aware storage. Not just key-values (e.g., a map or hash), where values are &#8220;blobs&#8221;, but also <span class="caps">API</span> calls specifically for working with strings, lists, sets, and sorted sets.</p>
</div>
<div class="slide">
<h1>Redis</h1>
<p>Other features:</p>
<ul>
	<li>Many language bindings.</li>
	<li>Very high speed.</li>
	<li>Integrated into Akka (for durable persistent data structures).</li>
	<li>Limited support for fault tolerance and clustering.</li>
</ul>
<p>So, useful for the same sorts of tasks MemcacheDB would be used for, plus cases where awareness of the additional data structures is useful.</p>
</div>
<div class="slide">
<h1>Key-Value Store: General Considerations</h1>
<ul>
	<li>How often is data synced to disk?</li>
	<li>How is data replicated to other nodes (for distributed stores)?</li>
	<li>How is fault tolerance supported?</li>
</ul>
</div>
<div class="slide">
<h1>Reading Assignment: CouchDB</h1>
<p>Read <a href="http://guide.couchdb.org/editions/1/en/why.html">Chapter 1</a> of <em>CouchDB, The Definitive Guide</em>, which describes the philosophy behind CouchDB, the kinds of applications it is suitable for, etc.</p>
</div>
<div class="slide">
<h1>Reading Assignment: MongoDB</h1>
<p>Read the MongoDB pages on <a href="http://www.mongodb.org/display/DOCS/Querying">queries</a> and <a href="http://www.mongodb.org/display/DOCS/Advanced+Queries">advanced queries</a>. We&#8217;ll use them in today&#8217;s exercise (discussed below).</p>
</div>
<div class="slide">
<h1>Reading Assignment: Amazon Dynamo</h1>
<p>Giuseppe DeCandia, Deniz Hastorun, Madan Jampani, Gunavardhan Kakulapati, Avinash Lakshman, Alex Pilchin, Swaminathan Sivasubramanian, Peter Vosshall and Werner Vogels, <a href="http://www.allthingsdistributed.com/2007/10/amazons_dynamo.html">Dynamo: Amazon’s Highly Available Key-value Store</a></p>
</div>
<div class="slide">
<h1>Reading Assignment: Cassandra</h1>
<p>Avinash Lakshman and Prashant Malik, <a href="http://www.cs.cornell.edu/projects/ladis2009/papers/lakshman-ladis2009.pdf">Cassandra — A Decentralized Structured Storage System</a></p>
</div>
<div class="slide">
<h1>Exercise: Mongo Queries</h1>
<p>This week, since I&#8217;ve given you longer reading assignments, I&#8217;ll give you a shorter exercise ;) We&#8217;ll use the mongo console to query the stock data. We&#8217;ll return to the web application next week, when we&#8217;ll incorporate some of this work in the application.</p>
<p>Start <code>mongodb</code> and <code>mongo</code> in separate command windows, as you&#8217;ve done before. On the next page is an example <code>mongo</code> session. They show the <code>&gt;</code> mongo prompt and the resulting output on my database instance. (Some of your results may be slightly different.)</p>
</div>
<div class="slide">
<h1>Exercise: Mongo Queries (cont.)</h1>
<p>Getting general help and help on database-level commands.</p>
<div class="code-small">
<pre name="code" id="code" class="brush: plain,;">

&gt; help()
	  db.help()                    help on db methods
	  db.mycoll.help()             help on collection methods
	  rs.help()                    help on replica set methods
		...
&gt; db.help()
DB methods:
	  db.addUser(username, password[, readOnly=false])
	  db.auth(username, password)
	  db.cloneDatabase(fromhost)
	  db.commandHelp(name) returns the help for the command
	  db.copyDatabase(fromdb, todb, fromhost)
	  db.createCollection(name, { size : ..., capped : ..., max : ... } )
		...
</pre></div>
<p></p>
</div>
<div class="slide">
<h1>Exercise: Mongo Queries (cont.)</h1>
<p>Getting collection-level commands.</p>
<div class="code-small">
<pre name="code" id="code" class="brush: plain,;">

&gt; db.foo.help()
DBCollection help
	  db.foo.find().help() - show DBCursor help
	  db.foo.count()
	  db.foo.dataSize()
	  db.foo.distinct( key ) - eg. db.foo.distinct( 'x' )
	  db.foo.drop() drop the collection
	  db.foo.dropIndex(name)
	  ...
</pre></div>
<p><strong>Note:</strong> <code>foo</code> is just a placeholder. You can use any real collection name instead.</p>
</div>
<div class="slide">
<h1>Exercise: Mongo Queries (cont.)</h1>
<div class="code-small">
<pre name="code" id="code" class="brush: plain,;">

&gt; show dbs
admin
local
stocks_yahoo_NYSE
&gt; use stocks_yahoo_NYSE
switched to db stocks_yahoo_NYSE
&gt; show collections
A_dividends
A_prices
B_dividends
B_prices
C_dividends
C_prices
...
</pre></div>
</div>
<div class="slide">
<h1>Exercise: Mongo Queries (cont.)</h1>
<p>How many documents in a collection? Show me one item:</p>
<div class="code-small">
<pre name="code" id="code" class="brush: plain,;">

&gt; db.A_dividends.count()
8322
&gt; db.A_prices.count()
693733
&gt; db.A_dividends.findOne()
{
    "_id" : ObjectId("4c9f75bbf0c81d093e48b0cc"),
    "date" : "2007-09-26",
    "dividends" : 0.04,
    "stock_symbol" : "ATU",
    "exchange" : "NYSE"
}
...
</pre></div>
</div>
<div class="slide">
<h1>Exercise: Mongo Queries (cont.)</h1>
<div class="code-small">
<pre name="code" id="code" class="brush: plain,;">

&gt; db.A_prices.findOne()
{
    "_id" : ObjectId("4c9f7586f0c81d093e3e1ae7"),
    "close" : 27.13,
    "high" : 27.4,
    "date" : "2008-03-07",
    "stock_symbol" : "ATU",
    "exchange" : "NYSE",
    "volume" : 591000,
    "adj close" : 27.13,
    "low" : 26.18,
    "open" : 26.18
}
...
</pre></div>
</div>
<div class="slide">
<h1>Exercise: Mongo Queries (cont.)</h1>
<p>Find all unique values for a particular field in the collection.</p>
<div class="code-small">
<pre name="code" id="code" class="brush: plain,;">

&gt; db.A_prices.distinct("stock_symbol")          
[
    "AA",
    "AAI",
    "AAP",
    "AAR",
    "AAV",
    "AB",
    "ABA",
    "ABB",
    "ABC",
...
</pre></div>
</div>
<div class="slide">
<h1>Exercise: Mongo Queries (cont.)</h1>
<p>Find all documents matching a specific field value, limited to 5 items.</p>
<div class="code-tiny">
<pre name="code" id="code" class="brush: plain,;">

&gt; db.A_prices.find({stock_symbol: "AA"}).limit(5)
{ "_id" : ObjectId("4c9f75a2f0c81d093e445ce3"), "close" : 36.6, "high" : 37.9, "date" : "2008-03-07", "stock_symbol" : "AA", "exchange" : "NYSE", "volume" : 17752400, "adj close" : 36.6, "low" : 36.13, "open" : 37.01 }
{ "_id" : ObjectId("4c9f75a2f0c81d093e445ce4"), "close" : 38.37, "high" : 39.28, "date" : "2008-03-06", "stock_symbol" : "AA", "exchange" : "NYSE", "volume" : 11279900, "adj close" : 38.37, "low" : 38.26, "open" : 38.85 }
{ "_id" : ObjectId("4c9f75a2f0c81d093e445ce5"), "close" : 38.71, "high" : 39.15, "date" : "2008-03-05", "stock_symbol" : "AA", "exchange" : "NYSE", "volume" : 11754600, "adj close" : 38.71, "low" : 38.1, "open" : 38.25 }
{ "_id" : ObjectId("4c9f75a2f0c81d093e445ce6"), "close" : 38, "high" : 38.94, "date" : "2008-03-04", "stock_symbol" : "AA", "exchange" : "NYSE", "volume" : 15715600, "adj close" : 38, "low" : 37.1, "open" : 37.9 }
{ "_id" : ObjectId("4c9f75a2f0c81d093e445ce7"), "close" : 38.32, "high" : 38.46, "date" : "2008-03-03", "stock_symbol" : "AA", "exchange" : "NYSE", "volume" : 13964700, "adj close" : 38.32, "low" : 37.13, "open" : 37.17 }
...
</pre></div>
</div>
<div class="slide">
<h1>Exercise: Mongo Queries (cont.)</h1>
<p>Find all documents matching a specific field value, sorted by date (both ways), limited to 3 items.</p>
<div class="code-tiny">
<pre name="code" id="code" class="brush: plain,;">

&gt; db.A_prices.find({stock_symbol: "AA"}).sort({date: 1}).limit(3)
{ "_id" : ObjectId("4c9f75a3f0c81d093e448a4b"), "close" : 65.37, "high" : 65.75, "date" : "1962-01-02", "stock_symbol" : "AA", "exchange" : "NYSE", "volume" : 134400, "adj close" : 0.74, "low" : 65.37, "open" : 65.37 }
{ "_id" : ObjectId("4c9f75a3f0c81d093e448a4a"), "close" : 66.37, "high" : 66.37, "date" : "1962-01-03", "stock_symbol" : "AA", "exchange" : "NYSE", "volume" : 179200, "adj close" : 0.75, "low" : 65.25, "open" : 65.37 }
{ "_id" : ObjectId("4c9f75a3f0c81d093e448a49"), "close" : 66.37, "high" : 66.87, "date" : "1962-01-04", "stock_symbol" : "AA", "exchange" : "NYSE", "volume" : 193600, "adj close" : 0.75, "low" : 66.37, "open" : 66.37 }
&gt; db.A_prices.find({stock_symbol: "AA"}).sort({date: -1}).limit(3)
{ "_id" : ObjectId("4c9f75a2f0c81d093e445ce3"), "close" : 36.6, "high" : 37.9, "date" : "2008-03-07", "stock_symbol" : "AA", "exchange" : "NYSE", "volume" : 17752400, "adj close" : 36.6, "low" : 36.13, "open" : 37.01 }
{ "_id" : ObjectId("4c9f75a2f0c81d093e445ce4"), "close" : 38.37, "high" : 39.28, "date" : "2008-03-06", "stock_symbol" : "AA", "exchange" : "NYSE", "volume" : 11279900, "adj close" : 38.37, "low" : 38.26, "open" : 38.85 }
{ "_id" : ObjectId("4c9f75a2f0c81d093e445ce5"), "close" : 38.71, "high" : 39.15, "date" : "2008-03-05", "stock_symbol" : "AA", "exchange" : "NYSE", "volume" : 11754600, "adj close" : 38.71, "low" : 38.1, "open" : 38.25 }
...
</pre></div>
</div>
<div class="slide">
<h1>Exercise: Mongo Queries (cont.)</h1>
<p>Find the historical high and low closing values for AA.</p>
<div class="code-tiny">
<pre name="code" id="code" class="brush: plain,;">

&gt; db.A_prices.find({stock_symbol: "AA"}).sort({close: 1}).limit(1)
{ "_id" : ObjectId("4c9f75a2f0c81d093e446234"), "close" : 18.03, "high" : 18.4, "date" : "2002-10-09", "stock_symbol" : "AA", "exchange" : "NYSE", "volume" : 4345100, "adj close" : 16.04, "low" : 17.81, "open" : 18 }
&gt; db.A_prices.find({stock_symbol: "AA"}).sort({close: -1}).limit(1)
{ "_id" : ObjectId("4c9f75a3f0c81d093e44860f"), "close" : 94.5, "high" : 94.5, "date" : "1966-04-21", "stock_symbol" : "AA", "exchange" : "NYSE", "volume" : 235200, "adj close" : 1.15, "low" : 92.75, "open" : 93.12 }
...
</pre></div>
</div>
<div class="slide">
<h1>Exercise: Mongo Queries (cont.)</h1>
<p>Using logical comparison operations. (There are others&#8230;)</p>
<div class="code-tiny">
<pre name="code" id="code" class="brush: plain,;">

&gt; db.A_prices.find({close: { $lte: 25.0}}).limit(3)
{ "_id" : ObjectId("4c9f7586f0c81d093e3e2126"), "close" : 24.75, "high" : 25.57, "date" : "2001-10-25", "stock_symbol" : "ATU", "exchange" : "NYSE", "volume" : 116400, "adj close" : 6.16, "low" : 24.5, "open" : 25.55 }
{ "_id" : ObjectId("4c9f7586f0c81d093e3e212a"), "close" : 24.8, "high" : 25, "date" : "2001-10-19", "stock_symbol" : "ATU", "exchange" : "NYSE", "volume" : 101200, "adj close" : 6.17, "low" : 24.1, "open" : 24.4 }
{ "_id" : ObjectId("4c9f7586f0c81d093e3e212b"), "close" : 24.15, "high" : 24.99, "date" : "2001-10-18", "stock_symbol" : "ATU", "exchange" : "NYSE", "volume" : 36000, "adj close" : 6.01, "low" : 24.15, "open" : 24.8 }
&gt; db.A_prices.find({close: { $gte: 25.0}}).limit(3)
{ "_id" : ObjectId("4c9f7586f0c81d093e3e1ae7"), "close" : 27.13, "high" : 27.4, "date" : "2008-03-07", "stock_symbol" : "ATU", "exchange" : "NYSE", "volume" : 591000, "adj close" : 27.13, "low" : 26.18, "open" : 26.18 }
{ "_id" : ObjectId("4c9f7586f0c81d093e3e1ae8"), "close" : 27.07, "high" : 27.72, "date" : "2008-03-06", "stock_symbol" : "ATU", "exchange" : "NYSE", "volume" : 679200, "adj close" : 27.07, "low" : 27, "open" : 27.35 }
{ "_id" : ObjectId("4c9f7586f0c81d093e3e1ae9"), "close" : 27.56, "high" : 27.89, "date" : "2008-03-05", "stock_symbol" : "ATU", "exchange" : "NYSE", "volume" : 478500, "adj close" : 27.56, "low" : 27.14, "open" : 27.48 }
...
</pre></div>
</div>
<div class="slide">
<h1>Exercise: Mongo Queries (cont.)</h1>
<p>Using JavaScript expressions in queries.</p>
<div class="code-tiny">
<pre name="code" id="code" class="brush: plain,;">

&gt; db.B_prices.find("this.stock_symbol.length == 2").limit(1)
{ "_id" : ObjectId("4c9f75bcf0c81d093e48ed60"), "close" : 15.39, "high" : 15.92, "date" : "2008-03-07", "stock_symbol" : "BC", "exchange" : "NYSE", "volume" : 1542700, "adj close" : 15.39, "low" : 15.2, "open" : 15.61 }
...
</pre></div>
</div>
<div class="slide">
<h1>Exercise: Mongo Queries (cont.)</h1>
<p>Using regular expressions in queries. Limiting the fields returned.</p>
<div class="code-tiny">
<pre name="code" id="code" class="brush: plain,;">

&gt; db.D_prices.find({stock_symbol: /D.*G$/}).limit(1)
{ "_id" : ObjectId("4c9f7611f0c81d093e5d78ed"), "close" : 12.68, "high" : 12.88, "date" : "2008-03-07", "stock_symbol" : "DHG", "exchange" : "NYSE", "volume" : 194900, "adj close" : 12.68, "low" : 12.55, "open" : 12.69 }
&gt; db.D_prices.find({stock_symbol: /D.*G$/}, {stock_symbol:1, _id:0}).limit(1)
{ "stock_symbol" : "DHG" }
...
</pre></div>
</div>
<div class="slide">
<h1>Exercise: Mongo Queries (cont.)</h1>
<p>Finally, some more involved JavaScript.</p>
<div class="code-tiny">
<pre name="code" id="code" class="brush: plain,;">

&gt; var ds = db.D_prices.distinct("stock_symbol") 
&gt; for (i in ds) { var d = ds[i]; if (d.charAt(d.length-1) == "T") print(d); }
DCT
DDT
DFT
DHT
DKT
DST
DT
DTT
...
</pre></div>
</div>
<div class="slide">
<h1>Exercise: Mongo Queries (cont.)</h1>
<p>Now for the exercises: Email your answers to the following questions by the start of class next week. You can capture the output of your terminal session, if you want. Whatever you do, show me the answer for each question, as well as the query (or queries) you used to get it.</p>
<ul>
	<li>What were the earliest and latest trading dates for the stock with the symbol <code>BAM</code>?</li>
	<li>What were the highest and lowest closing prices for <code>CSC</code> and on what dates did they occur?</li>
	<li>Write a query that returns the first 100 trading days from the A table where the price closed above $100. Limit the fields returned to show just the date, the stock symbol, and the closing price (also suppress the id). Show the results of the query.</li>
</ul>
</div>
<div class="slide">
<h1>Exercise: Mongo Queries (cont.)</h1>
<ul>
	<li>The &#8220;volume&#8221; is the number of shares traded that day. What &#8220;A&#8221; stock had the lowest number of shares traded in a day, <em>other than zero</em>, and what was the date (or dates).</li>
	<li>How many times did &#8220;AA&#8221; pay a dividend?</li>
	<li>How many times did &#8220;AA&#8221; pay a dividend in 2007? What were the dates when those dividends were paid?</li>
	<li>What stock symbols start with &#8220;C&#8221; and end with &#8220;M&#8221;?<br />
</div><br />
<div class="slide"></li>
</ul>
<h1 class="slide0">Lecture 6: Scaling Data, Part <span class="caps">III</span></h1>
<p>We end our tour of new database technologies with a discussion of column-oriented databases and graph databases.</p>
</div>
<div class="slide">
<h1>Cassandra: A Column-Oriented Database</h1>
<p>Design goals:</p>
<ul>
	<li>Reliability through distributed processing, no single point of failure.</li>
	<li>High write throughput.</li>
	<li>Trade <span class="caps">RDBMS</span> features for a simple data model with easy, dynamic control over data layout and format.</li>
</ul>
</div>
<div class="slide">
<h1>Cassandra: Developed at Facebook</h1>
<p>Originally designed for Facebook&#8217;s Inbox Search feature.</p>
<ul>
	<li>Very high write throughput required.</li>
	<li>Replication to geographically-distributed data centers.
	<ul>
		<li>Minimizes search latencies.</li>
	</ul></li>
</ul>
</div>
<div class="slide">
<h1>Cassandra: Inspirations</h1>
<ul>
	<li>Inspired by Amazon&#8217;s Dynamo and Google&#8217;s BigTable.
	<ul>
		<li>But provides better write performance.</li>
	</ul></li>
	<li>Open-source Apache Project.
	<ul>
		<li>But Facebook has maintained its own fork.</li>
	</ul></li>
</ul>
</div>
<div class="slide">
<h1>Cassandra: Columns</h1>
<p><em>Column Oriented</em> means that columns are easy to query for, as well as to add and remove in the &#8220;schema&#8221;. This supports evolution of features.</p>
<p>However, operations are keyed by rows and each row operation is atomic, independent of the number of columns involved.</p>
</div>
<div class="slide">
<h1>Cassandra: Columns</h1>
<ul>
	<li><strong>Column Families:</strong> a group of columns.
	<ul>
		<li><strong>Super Column Family</strong>: a column family within a column family.</li>
	</ul></li>
</ul>
</div>
<div class="slide">
<h1><span class="caps">API</span></h1>
<p>Just 3 methods:</p>
<ul>
	<li>insert(table, key, rowMutation)</li>
	<li>get(table, key, columnName)</li>
	<li>delete(table, key, columnName)</li>
</ul>
<p><em>columnName</em> can refer to a single column, or a column family.</p>
</div>
<div class="slide">
<h1>Distributed System Techniques</h1>
<p>Cassandra uses many distributed system techniques for scaling and availability. We&#8217;ll discuss these:</p>
<ul>
	<li>Partitioning</li>
	<li>Replication</li>
	<li>Membership</li>
	<li>Failure Handling</li>
	<li>Scaling</li>
</ul>
</div>
<div class="slide">
<h1>Partitioning</h1>
<p>Dynamically partition the data over the cluster.</p>
<ul>
	<li>To hard to do this manually.</li>
	<li>Keys are hashed, using consistent hashing.</li>
	<li>The range of possible hash values is treated as a &#8220;ring&#8221; that wraps.</li>
	<li>Each node is assigned a random position on the ring.<br />
 <br />
When a row&#8217;s key is hashed, the node with the closest key <em>greater than</em> the row&#8217;s key is assigned the responsibility for coordinating reads and writes.</li>
</ul>
</div>
<div class="slide">
<h1>Reads and Writes</h1>
<p>The responsible node decides what replicas should also handle the request.</p>
<ul>
	<li>Reads can be configured to use the value of the nearest replica or a <em>quorum</em> of replica responses.</li>
	<li>Writes are routed to all the designated replicas and the write is only considered complete when a <em>quorum</em> of replicas respond that the write was successful.</li>
</ul>
</div>
<div class="slide">
<h1>Failures and Balancing</h1>
<p>If a node fails or a new one is added, only its immediate neighbor nodes in the ring are affected.</p>
<p>The initial distribution of nodes doesn&#8217;t account for the actual distribution of keys in the data nor the performance of particular nodes. Hence, it can be imbalanced. Cassandra will move nodes on the ring to adjust performance.</p>
</div>
<div class="slide">
<h1>Replication</h1>
<p>Each Cassandra &#8220;instance&#8221; is configured with a <em>replication factor</em> of N, the number of nodes to which each data item is replicated.</p>
<p>When a node is responsible for a row, it stores the row locally and replicates it to N-1 other nodes.</p>
<p>Cassandra can be configured to ensure that each row is replicated across multiple data centers, so every row remains available even in the event of a total failure of a data center.</p>
</div>
<div class="slide">
<h1>Membership</h1>
<p>Membership and health of the nodes is managed through a <em>Gossip</em> protocol called <em>Scuttlebutt</em>. The <em>Phi Accrual Failure Detector</em> module is used by each node to publish its &#8220;suspicions&#8221; about the health of every other node, rather than publishing an &#8220;up&#8221; or &#8220;down&#8221; report that may not be accurate. The suspicion level rises, as concerns about a node rise. At the same time, the probability of error decreases.</p>
<p>This turns out to be a much faster way to detect node failure than other detection schemes.</p>
</div>
<div class="slide">
<h1>Bootstrapping</h1>
<p>When a node starts for the first time, it chooses a random position on the ring, then &#8220;Gossips&#8221; its position to the cluster. This is how all the other nodes know the members of the cluster, for replication, etc.</p>
</div>
<div class="slide">
<h1>Scaling</h1>
<p>A new node can be assigned a key that allows it to offload an overloaded node. The overloaded node then uses kernel-to-kernel copying techniques to move the data it is no longer responsible for to the new node.</p>
</div>
<div class="slide">
<h1>Local Persistence: Writes</h1>
<p>For local storage, Cassandra relies on the local file system. (By contrast, Google&#8217;s BigTable is designed for <span class="caps">GFS</span>, a distributed file system.)</p>
<p>Writes are appended to a commit log. Only <em>after</em> this succeeds is the same change written to an in-memory data structure.</p>
<p>Facebook uses a dedicated disk on each system for the commit log, to minimize seeks and thereby optimize writes.</p>
<p>When the in-memory storage reaches a certain size threshold, it is written to another disk and the rows are indexed for fast retrieval.</p>
</div>
<div class="slide">
<h1>Local Persistence: Writes</h1>
<p>Over time, many such files written from the in-memory data structure will exist. A background process merges them into one file. Also, old commit logs are eventually deleted, once the in-memory structures they represent are persisted.</p>
<p>Hence, durability is ensured through a combination of the commit log and the row files, replicated across the cluster.</p>
<p>Since no files are ever modified for updates, no locks are required. Cassandra also groups writes to be synchronous, maximizing disk write speeds.</p>
</div>
<div class="slide">
<h1>Local Persistence: Reads</h1>
<p>First, the in-memory data structure is searched for the row. If not found, the <em>newest</em> to <em>oldest</em> files are searched, in order.</p>
<p>To avoid searching a file that is unlikely to contain the row, a <em>bloom filter</em> that summarizes the keys in the file is also stored in the file and and memory. It is examined to determine if the file has the row.</p>
<p>Column locations are also indexed, so getting to the correct disk block is optimized.</p>
</div>
<div class="slide">
<h1>Cassandra and Column Databases: Conclusion</h1>
<ul>
	<li>Great for schema that need to evolve by adding columns.</li>
	<li>Great for fast queries by column(s), without reading entire rows.</li>
	<li>Optimized for write performance, while maintaining fast reads.</li>
	<li>Trade full <span class="caps">RDBMS</span> features for flexibility and performance.</li>
</ul>
</div>
<div class="slide">
<h1>Graph Databases</h1>
<p>Graph databases model relationships as first class features.</p>
<p>Contrast with relational databases, where relationships are managed through joins over keys from one set of records to another set of records, either in the same table or different tables. For M:N relationships, you have to manually create a separate <em>join table</em>. For data best modeled as a <em>network</em> of <em>nodes</em>, this isn&#8217;t very convenient, nor does it perform well, in most cases.</p>
</div>
<div class="slide">
<h1>Graph Examples</h1>
<ul>
	<li>The Internet!</li>
	<li>Physical maps: streets, public transit, geography, etc.</li>
	<li>Complex business rules.</li>
	<li>Manifests for shipping.</li>
	<li>Parts lists and their relationships for assembly lines and finished products (e.g., airplanes!).</li>
</ul>
</div>
<div class="slide">
<h1>Graph Databases and OO Middleware</h1>
<p>An <em>object</em> is actually a graph of smaller objects:</p>
<ul>
	<li>Smaller graphs (collections).</li>
	<li>&#8220;Leaf&#8221; nodes, like integers, floats, etc.</li>
</ul>
<p>(It&#8217;s sometimes useful to treat other small objects, like strings as leaf nodes, too.)</p>
<p>Hence, for applications with complex object graphs, a graph database might be a better fit than a relational database.</p>
</div>
<div class="slide">
<h1>Elements of a Graph Database</h1>
<p>At its core a graph database supports the following concepts from standard graph theory.</p>
<ul>
	<li>Nodes</li>
	<li>Arcs</li>
	<li>Properties</li>
</ul>
</div>
<div class="slide">
<h1>Nodes</h1>
<p>A node is analogous to a row in a relational database. In a graph for a particular application, it is an &#8220;entity&#8221; whose relationships to other entities are of primary interest.</p>
<p>Examples:</p>
<ul>
	<li>Twitter, Facebook, LinkedIn, etc. users.</li>
	<li>Airports served by an airline.</li>
	<li>Addresses to which mail and packages are delivered.</li>
</ul>
</div>
<div class="slide">
<h1>Arcs</h1>
<p>The connections (relationships) between nodes. Can be unidirectional or bidirectional.</p>
<p>Examples:</p>
<ul>
	<li>Your followers and who you follow on Twitter.</li>
	<li>Your friends and their friends, ad infinitum, on Facebook, LinkedIn, etc.</li>
	<li>Flight &#8220;legs&#8221; between two airports.</li>
	<li>Delivery route between two addresses for mail and/or package deliveries.</li>
</ul>
<p>Which of these are always bidirectional? Sometimes?</p>
</div>
<div class="slide">
<h1>Arcs (cont.)</h1>
<p>Traversals (paths) are formed from multiple, contiguous arcs.</p>
<ul>
	<li>They may be circular.
	<ul>
		<li>The may go from one node to another and back again.</li>
	</ul></li>
	<li>There will be dead ends.</li>
	<li>There will be clumps with relatively few arcs between the clumps.</li>
</ul>
<p>For a real-world example, see this video of a <a href="http://www.youtube.com/watch?v=se2u5RyGaNE">LinkedIn employee&#8217;s own social graph</a>.</p>
</div>
<div class="slide">
<h1>Properties</h1>
<p>Key-value pairs associated with nodes and arcs. Most of the interesting data is in these properties!</p>
<p>Example Properties for Nodes:</p>
<ul>
	<li>Where you live, your profession, interests, age, marital status, etc., etc.</li>
	<li>Airport capacity, number of gates, hours of operation, etc.</li>
	<li>Business or personal address? Apartment building or free standing house? Hostile dogs?</li>
</ul>
</div>
<div class="slide">
<h1>Properties (cont.)</h1>
<p>Example Properties for Arcs:</p>
<ul>
	<li>Is this a professional or personal relationship.</li>
	<li>How often is this relationship used?
	<ul>
		<li>Twitter direct messages.</li>
		<li>Emails sent.</li>
	</ul></li>
	<li>Daily flight schedule (including number of flights, passengers carried per flight, etc.).</li>
	<li>Distance between two addresses.</li>
	<li>Hazards or barriers between two addresses.</li>
</ul>
</div>
<div class="slide">
<h1>Graph Databases vs. Others</h1>
<p>Recall that most of the database <em>kinds</em> we&#8217;ve discussed can scale through <em>sharding</em>. That <strong>assumes</strong> there are relatively few relationships between the shards. Graph databases <em>emphasize</em> connections, so sharding requires careful understanding of the actual clumps in the data.</p>
<p>Where <em>joins</em> can be expensive in an <span class="caps">RDBMS</span>, graphs optimize traversals.</p>
</div>
<div class="slide">
<h1>Neo4J</h1>
<p><a href="http://neo4j.org">Neo4J</a> and its Wikipedia <a href="http://en.wikipedia.org/wiki/Neo4j">page</a>.</p>
<p>Neo4j is a graph database. It is an embedded, disk-based, fully-transactional Java persistence engine that stores data structured in graphs rather than in tables.</p>
</div>
<div class="slide">
<h1>Neo4J: Features</h1>
<ul>
	<li>Object-oriented Java <span class="caps">API</span>.</li>
	<li>massive scalability; handles graphs of several billion nodes/relationships/properties on a single machine and can be sharded to scale out across multiple machines.</li>
	<li>Support for common <span class="caps">RDBMS</span> database features:
	<ul>
		<li><span class="caps">ACID</span> transactions.</li>
		<li>Durable persistence.</li>
		<li>Concurrency control.</li>
	</ul></li>
</ul>
</div>
<div class="slide">
<h1>FlockDB</h1>
<p><a href="http://en.wikipedia.org/wiki/FlockDB">Wikipedia</a> and on <a href="http://github.com/twitter/flockdb">GitHub</a>.</p>
<p>Goals:</p>
<ul>
	<li>High throughput for add/update/remove operations.</li>
	<li>Support complex arithmetic queries.</li>
	<li>Paging through query result sets with millions of entries.</li>
	<li>Archiving of edges with later retrieval.</li>
	<li>Horizontal scaling, including replication.</li>
	<li>Online data migration</li>
</ul>
</div>
<div class="slide">
<h1>FlockDB</h1>
<p>Non-goals include:</p>
<ul>
	<li>Multi-hop queries (or graph-walking queries)</li>
	<li>Automatic shard migrations</li>
</ul>
<p>FlockDB tries to solve fewer problems, such as Neo4J, so it is much simpler than other graph databases.</p>
</div>
<div class="slide">
<h1>Developed at Twitter</h1>
<p>Twitter uses FlockDB to store social graphs (who follows whom, who blocks whom) and secondary indices. As of April 2010, the Twitter FlockDB cluster stores 13+ billion edges and sustains peak traffic of 20k writes/second and 100k reads/second.</p>
<p>Written in Scala.</p>
</div>
<div class="slide">
<h1>Gephi: An Open-Source Tool for Graph Analysis.</h1>
<p><a href="http://gephi.org">gephi.org</a>.</p>
<p>An open-source tool for visualizing and analyzzing large networks graphs.</p>
<ul>
	<li>Uses a 3D render engine to display graphs in real-time.</li>
	<li>Supports data exploration, analysis, filtering, manipulation, and graphing of graph data.</li>
</ul>
</div>
<div class="slide">
<h1>Gephi: Gotchas</h1>
<p>It&#8217;s a Java app that uses a lot of <span class="caps">RAM</span>.</p>
<p>The included example graph, of the relationships between characters in the Phantom of the Opera, runs fine with the default configuration.</p>
<p>For larger graphs, follow the instructions for increasing the heap size. Only run it on a reasonably powerful machine.</p>
</div>
<div class="slide">
<h1>Graph Databases: Conclusion</h1>
<p><a href="http://portal.acm.org/citation.cfm?id=1322433">Survey of Graph Database Models</a> provides a detailed survey (requires <span class="caps">ACM</span> online access).</p>
<p><a href="http://nosqlsummer.org/paper/graph-traversal-pattern">The Graph Traversal Pattern</a> is a technical paper on graph databases.</p>
</div>
<div class="slide">
<h1>Reading Assignment: Cassandra</h1>
<ul>
	<li><a href="http://en.wikipedia.org/wiki/Apache_Cassandra">Apache Cassandra</a> (Wikipedia).</li>
	<li>Avinash Lakshman and Prashant Malik, <a href="http://www.cs.cornell.edu/projects/ladis2009/papers/lakshman-ladis2009.pdf">Cassandra &#8211; A Decentralized, Structured Storage System</a>.</li>
</ul>
</div>
<div class="slide">
<h1>Reading Assignment: Graph Databases</h1>
<p>Rather than a reading on graph databases, read this Wikipedia page on graphs in computer science, which describes the fundamental terminology used in graph databases, too.</p>
<ul>
	<li><a href="http://en.wikipedia.org/wiki/Graph_(data_structure)">Graph data structure</a> (Wikipedia).</li>
</ul>
</div>
<div class="slide">
<h1>Reading Assignment: MapReduce</h1>
<p>In preparation for our next class, when we&#8217;ll finally discuss MapReduce, read the classic paper that introduced the first MapReduce framework, used at Google.</p>
<ul>
	<li><a href="http://en.wikipedia.org/wiki/MapReduce">MapReduce</a> (Wikipedia).</li>
</ul>
</div>
<div class="slide">
<h1>Exercise: Filter Stock Queries</h1>
<p>Since we started, the project has had one major flaw; if you query for closing prices for a list of stocks, you get the results for <em>all</em> stocks in the same tables. We did one fix in an earlier exercise, where we filtered the results after the database query was made. Now let&#8217;s do it in a more appropriate way, as part of the query itself.</p>
</div>
<div class="slide">
<h1>Exercise: Filter Stock Queries (cont.)</h1>
<p>Several pieces are already in place. <code>RestfulDataPublisher</code> already sends the &#8220;instrument&#8221; information to the <code>InstrumentAnalysisServerSupervisor</code> in a <code>CriteriaMap</code> object. (<code>CriteriaMap</code> wraps a normal <code>Map</code> with some convenience methods.)</p>
<p><code>InstrumentAnalysisServerSupervisor</code> sends the instrument information to the <code>InstrumentAnalysisServers</code>, in a modified <code>CriteriaMap</code>. However, <code>InstrumentAnalysisServer</code> does not pass this information any further down the stack.</p>
</div>
<div class="slide">
<h1>Exercise: Filter Stock Queries (cont.)</h1>
<p>Look at <code>InstrumentAnalysisServerHelper.fetchPrices</code> (in <code>InstrumentAnalysisServer.scala</code>). Note the <code>Map</code> it passes to <code>DataStoreServer</code>. It passes a <code>Map</code> object, rather than a <code>CriteriaMap</code>, to provide a clean separation between the &#8220;domain-specific&#8221; <code>CriteriaMap</code> and <code>InstrumentAnalysisServer</code> higher in the &#8220;stack&#8221;, and the more generic <code>DataStoreServer</code> and <code>DataStore</code> types lower down:</p>
<div class="code-tiny">
<pre name="code" id="code" class="brush: scala,;">

dataStorageServer !! Get(Map("start" -&gt; start, "end" -&gt; end))
</pre></div>
<p>(Note, I recently refactored the project to use a <code>Map</code>, rather than a Lift <span class="caps">JSON</span> <code>JValue</code>, due to problems with the latter&#8230;)</p>
</div>
<div class="slide">
<h1>Exercise: Filter Stock Queries (cont.)</h1>
<p><code>("start" -&gt; start)</code> is converted to a <code>Pair[String, org.joda.time.DateTime]</code> before they are passed to the <code>Map</code> &#8220;factory&#8221; method. For example, if the <code>start</code> value is &#8220;2010-10-01&#8221; and <code>end</code> is &#8220;2010-10-05&#8221;, the map would be.</p>
<div class="code-small">
<pre name="code" id="code" class="brush: javascript,;">

Map("start" -&gt; "2010-10-01", "end" -&gt; "2010-10-05")
</pre></div>
</div>
<div class="slide">
<h1>Exercise: Filter Stock Queries (cont.)</h1>
<p>Step 1: Start <code>sbt</code></p>
<ul>
	<li>Start <code>sbt</code>.</li>
	<li>Run the <code>~test</code> action to continuously check for broken code.</li>
</ul>
</div>
<div class="slide">
<h1>Exercise: Filter Stock Queries (cont.)</h1>
<p>Step 2: Add the instruments</p>
<ul>
	<li>Add another <code>Pair</code> to the <code>Map</code> inside the <code>Get</code> message object sent to the <code>dataStoreServer</code>. Use <code>stock_symbol</code> as the key and a new list, named <code>symbols</code> as the value. Note that the <code>instruments</code> parameter to the method is of type <code>List[Instrument]</code>. All we want is a <code>List[String]</code>, where each <code>String</code> is the <code>symbol</code> field in the corresponding <code>Instrument</code>.</li>
</ul>
<ul>
	<li>Create a local <code>val</code> named <code>symbols</code>. Initialize it with the list of symbols (<code>Strings</code>) created by calling the <code>map</code> method on <code>instruments</code> and passing a block that extracts the <code>symbol</code> field from each instrument. (Hint: there is already a method to do this, in <code>object Instrument</code>.)</li>
	<li>In the <code>Get(Map(...))</code> sent to the <code>dataStorageServer</code>, add the key-value pair with &#8220;stock_symbol&#8221; as the key and the new <code>symbols</code> list as the value.</li>
</ul>
</div>
<div class="slide">
<h1>Exercise: Filter Stock Queries (cont.)</h1>
<p>Note that <code>InstrumentAnalysisServer</code> has many details about how domain concepts, like &#8220;instruments&#8221; are mapped to the actual storage details, like &#8220;stock_symbol&#8221;, so that <code>DataStorageServer</code> and the <code>DataStore</code> types can remain relatively agnostic about domain concepts. This makes them more reusable for other applications.</p>
</div>
<div class="slide">
<h1>Exercise: Filter Stock Queries (cont.)</h1>
<p>Step 3: Extend <code>DataStorageServer</code> to use other query parameters.</p>
<p>In <code>DataStorageServer.getDataForRange</code>, the <code>critieria</code> object is passed in as an argument.</p>
<ul>
	<li>Add this <code>critieria</code> object as the <em>third</em> argument in the call to <code>DataStore.range</code>. (At this point, the compilation will fail in <code>sbt</code>.)</li>
</ul>
</div>
<div class="slide">
<h1>Exercise: Filter Stock Queries (cont.)</h1>
<p>Step 4: Extend the <code>DataStore</code> types to use this query object.</p>
<ul>
	<li>Modify the declaration of <code>DataStore.range</code> to accept this argument <strong>before</strong> the <code>maxNum</code> argument.
	<ul>
		<li>Give it the name <code>otherCriteria</code>.</li>
		<li>Give it a default value of <code>Map.empty</code> (one way of specifying an empty map). In other words, the <code>otherCriteria</code> argument will have this signature: <code>otherCriteria: Map[String,Any] = Map.empty</code>. (Note that the type parameters aren&#8217;t required on the right-hand side of the equals sign. Do you understand why?)</li>
	</ul></li>
</ul>
<ul>
	<li>Add the same argument to the definitions of <code>InMemoryDataStore.range</code> and <code>MongoDBDataStore.range</code>.</li>
</ul>
</div>
<div class="slide">
<h1>Exercise: Filter Stock Queries (cont.)</h1>
<p>Step 5: Fix the tests.</p>
<p>At this point, there should be a few test failures, all caused by changes that need to be made in <code>DataStoreTestBase</code>. Specifically, we are still calling the <code>range</code> method on a <code>DataStore</code> object without the new, third argument. Note that this is only a problem for the cases where we explicitly pass the <code>maxNum</code> argument. (Do you understand why that&#8217;s true?)</p>
<ul>
	<li>Look at the test error messages and find the lines in <code>DataStoreTestBase</code> where the changes are required.</li>
	<li>Insert <code>Map.empty</code> as the <em>third</em> argument to the <code>range</code> call, before the current third argument, the <code>maxNum</code> value.</li>
</ul>
<p>Now the tests should pass!</p>
</div>
<div class="slide">
<h1>Exercise: Filter Stock Queries (cont.)</h1>
<p>Step 6: Continue implementing the new query support.</p>
<p>Go back to <code>MongoDBDataStore</code> and look at the <code>range</code> method. Now we&#8217;ll use the new <code>otherCriteria</code> object. I recently refactored the code to use a MongoDB <code>QueryBuilder</code>. We need to append additional information to the query. To keep the exercise simpler, we&#8217;ll hard code the fact that <code>otherCriteria</code> may now have a key-value pair <code>("stock_symbol", List[String])</code>. (I say &#8220;may have&#8221;, because clients won&#8217;t always pass a <code>otherCriteria</code> map with this key-value pair, like some of the tests in <code>DataStoreTestBase</code>!)</p>
<ul>
	<li>Using the Scala <code>Map</code> <span class="caps">API</span>, add a conditional that tests for the presence of this key in <code>otherCriteria</code>.</li>
	<li>&#8230;</li>
</ul>
</div>
<div class="slide">
<h1>Exercise: Filter Stock Queries (cont.)</h1>
<p>Step 6 (cont.): Continue implementing the new query support.</p>
<ul>
	<li>If the key is found, add the key-value pair to the query:
	<ul>
		<li>Use the <code>QueryBuilder</code> code already in the method as an example.</li>
		<li>Find the JavaDocs for <code>QueryBuilder</code> and <code>BasicDBList</code> <a href="http://api.mongodb.org/java/2.2/index.html">here</a>.</li>
		<li>Write code that creates a <code>BasicDBList</code> and adds each element from the <code>symbols:List[String]</code> to it. (That is, we have to convert the Scala <code>List</code> to something MongoDB understands: <code>BasicDBList</code>.)</li>
		<li>Use the <code>and(key)</code> method and the <code>in(myBasicDBList)</code> methods on the <code>QueryBuilder</code> object (i.e., add these changes <strong>before</strong> the line that calls <code>qb.get</code>!).</li>
	</ul></li>
</ul>
</div>
<div class="slide">
<h1>Exercise: Filter Stock Queries (cont.)</h1>
<p>Step 7: Try it out!!</p>
<p>Run the application and open the web page in a browser. Enter a few stock symbols and date ranges. You should now see results only for the stocks you specified, not for all stocks in the same collection!</p>
<p>Note that we have left out some work; besides hard-coding a particular enhancement, rather than handling the general case, we haven&#8217;t supported this change in <code>InMemoryDataStore</code> and we haven&#8217;t updated our tests! We&#8217;ll fix this later.</p>
<p>Please push your work to GitHub by the start of class on October 19th.</p>
</div>
<div class="slide">
<h1>Reminder</h1>
<p><strong>No class</strong> next week (10/12).<br />
<strong>Midterm</strong>, the first 1/2 of our session on (10/19)</p>
</div>
<div class="title slide">
<h1>Lecture 7: Midterm Break (No Class)</h1>
<p>Have a good break!</p>
</div>
<div class="title slide">
<h1>Lecture 8: Midterm and Scaling Systems, Part II</h1>
<p>In this lecture, we&#8217;ll complete our discussion of distributed systems by examining the most popular framework for distributed data computation (&#8220;big data&#8221;): <a href="http://en.wikipedia.org/wiki/MapReduce">MapReduce</a>.</p>

</div>
<div class="slide">
<h1>Reading: Distributed Systems and &#8220;Big Data&#8221;</h1>
<p>To conclude our discussion of distributed systems and <em>big data</em>:</p>
<ul>
	<li>Arnon Rotem-Gal-Ozhttp, <a href="//www.rgoarchitects.com/Files/fallacies.pdf">Fallacies of Distributed Computing Explained</a></li>
	<li>Edd Dumbill, <a href="http://radar.oreilly.com/2010/09/the-smaq-stack-for-big-data.html">The <span class="caps">SMAQ</span> stack for big data</a>. Nice summary of some of the leading open-source technologies used for data processing.</li>
</ul>
</div>
<div class="slide">
<h1>Reading Assignment: MapReduce</h1>
<p>Read the classic paper that introduced the first MapReduce framework, used at Google.</p>
<ul>
	<li>Jeffrey Dean and Sanjay Ghemawat, <a href="http://labs.google.com/papers/mapreduce.html">MapReduce: Simplified Data Processing on Large Clusters</a>.</li>
</ul>
<p>These authors also wrote an chapter on MapReduce called <em>Distributed Programming with Mapreduce</em>, in &#8220;Beautiful Code&#8221;, Chapter 23, pgs. 371-382.</p>
</div>
<div class="title slide">
<h1>Lecture 9: Recent Advances in Object-Oriented Programming (<span class="caps">OOP</span>)</h1>
</div>
<div class="title slide">
<h1>Lecture 10: Functional Programming (FP): Into the Real World</h1>
</div>
<div class="title slide">
<h1>Lecture 11: Object-Oriented Programming vs. Functional Programming: a Critique of Pure Programming</h1>
</div>
<div class="title slide">
<h1>Lecture 12: Complexity vs. Simplicity Part I: Effective Software Development Processes</h1>
</div>
<div class="title slide">
<h1>Lecture 13: Complexity vs. Simplicity Part II: Scrum, XP, and Lean</h1>
</div>
<div class="slide">
<h1>Reading for Next Week&#8217;s Lecture</h1>
<ul>
	<li>Eric Brewer, <a href="http://www.cs.berkeley.edu/~brewer/cs262b-2004/PODC-keynote.pdf">Toward Robust, Distributed Systems</a>. The keynote at the <a href="http://www.podc.org/podc2000/"><span class="caps">ACM</span> Symposium on Principles of Distributed Computing</a> that introduced Brewer&#8217;s <span class="caps">CAP</span> theorem. Focus on the first 2/3^rd^s of the presentation (up to <em>The DQ Principle</em>.)<br />
</div><br />
<div class="slide"></li>
</ul>
<h1 class="slide0">Lecture 14: Complexity vs. Simplicity Part <span class="caps">III</span>: Simple Systems</h1>
</div>
<div class="title slide">
<h1>Lecture 15: Student Presentations on the Code Project and Course Review</div></h1>

  <!-- Syntax Highlighter -->
  <script language="javascript" type="text/javascript" src="../lib/scripts/shCore.js"></script>
  <script language="javascript" type="text/javascript" src="../lib/scripts/shBrushBash.js"></script>
  <script language="javascript" type="text/javascript" src="../lib/scripts/shBrushCpp.js"></script>
  <script language="javascript" type="text/javascript" src="../lib/scripts/shBrushCSharp.js"></script>
  <script language="javascript" type="text/javascript" src="../lib/scripts/shBrushCss.js"></script>
  <script language="javascript" type="text/javascript" src="../lib/scripts/shBrushDelphi.js"></script>
  <script language="javascript" type="text/javascript" src="../lib/scripts/shBrushJava.js"></script>
  <script language="javascript" type="text/javascript" src="../lib/scripts/shBrushJScript.js"></script>
  <script language="javascript" type="text/javascript" src="../lib/scripts/shBrushPhp.js"></script>
  <script language="javascript" type="text/javascript" src="../lib/scripts/shBrushPlain.js"></script>
  <script language="javascript" type="text/javascript" src="../lib/scripts/shBrushPython.js"></script>
  <script language="javascript" type="text/javascript" src="../lib/scripts/shBrushRuby.js"></script>
  <script language="javascript" type="text/javascript" src="../lib/scripts/shBrushScala.js"></script>
  <script language="javascript" type="text/javascript" src="../lib/scripts/shBrushSql.js"></script>
  <script language="javascript" type="text/javascript" src="../lib/scripts/shBrushVb.js"></script>
  <script language="javascript" type="text/javascript" src="../lib/scripts/shBrushXml.js"></script>
  <script language="javascript">
    SyntaxHighlighter.config.clipboardSwf = 'scripts/clipboard.swf';
    SyntaxHighlighter.all();
  </script>
</div>
</body>
</html>
